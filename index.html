<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>آکادمی سیلانه سبز</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1220;
      --card:#0f172a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border: rgba(229,231,235,.10);
      --shadow: 0 10px 26px rgba(0,0,0,.35);
      --primary:#60a5fa;
      --primary-weak: rgba(96,165,250,.14);
      --success:#22c55e;
      --danger:#ef4444;
      --radius: 18px;
    }

    body.tg {
      --bg: var(--tg-theme-bg-color, #0b1220);
      --card: var(--tg-theme-secondary-bg-color, #0f172a);
      --text: var(--tg-theme-text-color, #e5e7eb);
      --muted: var(--tg-theme-hint-color, #9ca3af);
      --primary: var(--tg-theme-button-color, #60a5fa);
    }

    *{ box-sizing: border-box; }
    body{
      margin:0;
      font-family: Vazirmatn, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 700px at 70% -10%, rgba(96,165,250,.12), transparent 60%),
                  radial-gradient(1000px 700px at 10% 0%, rgba(34,197,94,.10), transparent 55%),
                  var(--bg);
      color: var(--text);
      overflow-x:hidden;
    }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 18px 16px 28px;
    }

    .topbar{
      position: sticky;
      top: 0;
      z-index: 10;
      padding: 14px 0 10px;
      background: linear-gradient(to bottom, rgba(11,18,32,.92), rgba(11,18,32,.65), rgba(11,18,32,0));
      backdrop-filter: blur(10px);
    }

    .brand{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }

    .brandRight{
      display:flex;
      align-items:flex-start;
      gap: 12px;
      min-width: 0;
    }

    .logo{
      width: 42px;
      height: 42px;
      border-radius: 14px;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      flex: 0 0 auto;
      box-shadow: 0 10px 20px rgba(0,0,0,.25);
    }
    .logo img{ width: 100%; height: 100%; object-fit: cover; }

    .title{
      font-size: 22px;
      font-weight: 900;
      letter-spacing: -0.3px;
      margin: 0;
      line-height: 1.2;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 72vw;
    }

    .subtitle{
      margin-top: 6px;
      font-size: 13px;
      color: var(--muted);
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-weight: 800;
      font-size: 13px;
      white-space: nowrap;
    }

    .btnGhost{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-family: inherit;
      font-weight: 900;
    }
    .btnGhost:active{ transform: translateY(1px); }

    .controls{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1fr 240px;
      gap: 10px;
    }
    @media (max-width: 700px){
      .controls{ grid-template-columns: 1fr; }
    }

    .search{
      width:100%;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      outline: none;
      box-shadow: 0 1px 0 rgba(0,0,0,.02);
    }
    .search::placeholder{ color: rgba(156,163,175,.9); }

    .seg{
      display:flex;
      background: rgba(255,255,255,.04);
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow:hidden;
    }
    .seg button{
      flex:1;
      padding: 10px 10px;
      border:0;
      background: transparent;
      cursor:pointer;
      color: var(--muted);
      font-weight: 900;
      font-family: inherit;
    }
    .seg button.active{
      color: var(--primary);
      background: var(--primary-weak);
    }

    .toolbar{
      margin-top: 10px;
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
      justify-content: space-between;
    }

    .select{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      font-family: inherit;
      font-weight: 900;
      outline:none;
      min-width: 220px;
    }

    .grid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 860px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: rgba(15,23,42,.75);
      border: 1px solid var(--border);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding: 14px;
    }

    .itemHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
    }

    .itemTitle{
      font-weight: 900;
      margin: 0 0 6px;
      font-size: 16px;
      line-height: 1.4;
    }

    .meta{
      font-size: 13px;
      color: var(--muted);
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
    }

    .tag{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.05);
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
    }

    .btnPrimary{
      border: 0;
      border-radius: 16px;
      padding: 10px 14px;
      cursor:pointer;
      background: var(--primary);
      color: #071023;
      font-weight: 900;
      font-family: inherit;
      white-space: nowrap;
      box-shadow: 0 12px 22px rgba(96,165,250,.18);
    }
    body.tg .btnPrimary{
      color: var(--tg-theme-button-text-color, #071023);
    }
    .btnPrimary:active{ transform: translateY(1px); }

    .likeBtn{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 16px;
      cursor:pointer;
      font-family: inherit;
      font-weight: 900;
      display:inline-flex;
      gap: 8px;
      align-items:center;
    }
    .likeBtn.liked{
      border-color: rgba(96,165,250,.45);
      background: rgba(96,165,250,.14);
      color: var(--primary);
    }

    .progressRow{
      margin-top: 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .bar{
      flex:1;
      height: 10px;
      border-radius: 999px;
      background: rgba(156,163,175,.16);
      overflow:hidden;
      border: 1px solid var(--border);
    }
    .bar > div{
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--primary), var(--success));
      border-radius: 999px;
      transition: width .25s ease;
    }
    .percent{
      font-weight: 900;
      color: var(--text);
      min-width: 44px;
      text-align:left;
    }

    .catGrid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    @media (max-width: 700px){
      .catGrid{ grid-template-columns: 1fr; }
    }
    .catCard{
      padding: 16px;
      border-radius: 22px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      cursor: pointer;
      box-shadow: var(--shadow);
    }
    .catCard:active{ transform: translateY(1px); }
    .catName{
      font-size: 16px;
      font-weight: 900;
      margin: 0 0 6px;
    }
    .catDesc{
      margin: 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.6;
    }

    .hint{
      margin-top: 10px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.7;
    }

    .empty{
      margin-top: 12px;
      padding: 18px;
      text-align:center;
      color: var(--muted);
    }

    .overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 999;
    }
    .overlay.show{ display:flex; }
    .playerModal{
      width: min(980px, 96vw);
      max-height: 92vh;
      overflow:auto;
      background: rgba(15,23,42,.92);
      border: 1px solid var(--border);
      border-radius: 22px;
      box-shadow: 0 24px 60px rgba(0,0,0,.45);
      padding: 16px;
    }
    .playerHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
    }
    .playerTitle{
      margin:0;
      font-size: 16px;
      font-weight: 900;
      line-height: 1.5;
    }
    .closeBtn{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-family: inherit;
      font-weight: 900;
    }

    video,audio{
      width:100%;
      border-radius: 16px;
      outline:none;
      background: rgba(0,0,0,.25);
      margin-top: 12px;
    }

    .motivate{
      margin-top: 10px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.7;
    }

    .modalBackdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.60);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 1000;
    }
    .modalBackdrop.show{ display:flex; }
    .modal{
      width: min(560px, 96vw);
      background: rgba(15,23,42,.95);
      border: 1px solid var(--border);
      border-radius: 22px;
      box-shadow: 0 24px 60px rgba(0,0,0,.55);
      padding: 16px;
    }
    .modal h2{
      margin: 0 0 6px;
      font-size: 18px;
      font-weight: 900;
    }
    .modal p{
      margin: 0 0 12px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.8;
    }
    .formGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 560px){
      .formGrid{ grid-template-columns: 1fr; }
    }
    .inp{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      outline:none;
      font-family: inherit;
      font-weight: 700;
    }
    .inp::placeholder{ color: rgba(156,163,175,.85); }
    .modalFooter{
      margin-top: 12px;
      display:flex;
      justify-content:flex-end;
      gap: 10px;
      align-items:center;
    }

    .muted{ color: var(--muted); }
    .hidden{ display:none !important; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="brandRight">
          <div class="logo" title="سیلانه سبز">
            <img id="logoImg" alt="Seylaneh Sabz Logo" />
          </div>
          <div style="min-width:0;">
            <h1 class="title">آکادمی سیلانه سبز</h1>
            <div class="subtitle" id="tagline">یادگیری مستمر، مزیت رقابتی ما</div>
          </div>
        </div>

        <button id="btnChangeCategory" class="btnGhost hidden">تغییر دسته</button>
      </div>

      <div id="controlsBlock" class="hidden">
        <div class="controls">
          <input id="q" class="search" placeholder="جستجو در آموزش‌ها (مثلاً: فروش، محصول، ...)" />
          <div class="seg" role="tablist" aria-label="فیلتر نوع محتوا">
            <button id="f_all" class="active" type="button">همه</button>
            <button id="f_audio" type="button">پادکست</button>
            <button id="f_video" type="button">ویدیو</button>
          </div>
        </div>

        <div class="toolbar">
          <div class="pill" id="catPill">—</div>
          <select id="sortSel" class="select" aria-label="مرتب‌سازی">
            <option value="smart">مرتب‌سازی هوشمند (پیش‌فرض)</option>
            <option value="newest">جدیدترین محتوا</option>
            <option value="liked">بیشترین لایک</option>
            <option value="engaging">جذاب‌ترین محتوا</option>
          </select>
        </div>
      </div>
    </div>

    <div id="categoryGate">
      <div style="display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin-top:12px;">
        <div class="pill" style="border-radius:999px;">
          پیشرفت شما:
          <span id="overallProgress" style="font-weight:900; margin-right:6px;">0%</span>
        </div>

        <button id="btnContinue" class="btnGhost" style="border-radius:999px;" disabled>
          ادامه:
          <span id="continueTitle" style="font-weight:900; margin-right:6px;">—</span>
        </button>

        <div id="continueHint" class="hint" style="margin:0; flex-basis:100%; display:none;"></div>
      </div>

      <div class="catGrid" id="catGrid"></div>
    </div>

    <div id="listArea" class="hidden">
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:12px;">
        <div class="pill">
          پیشرفت این دسته:
          <span id="catProgress" style="font-weight:900; margin-right:6px;">0%</span>
          <span class="muted">•</span>
          <span id="catProgressHint" style="font-weight:900; margin-right:6px;">—</span>
        </div>

        <div class="pill" style="opacity:.9;">
          <span class="muted" id="microMotivation">هر قدم کوچک، یک عادت بزرگ می‌سازد.</span>
        </div>
      </div>

      <div id="list" class="grid"></div>
    </div>

  </div>

  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="playerModal">
      <div class="playerHead">
        <div>
          <h3 class="playerTitle" id="nowTitle">—</h3>
          <div class="meta" style="margin-top:6px;">
            <span class="tag" id="nowType">—</span>
            <span class="tag" id="nowDuration">—</span>
            <span class="tag" id="nowRemaining">—</span>
            <span class="tag" id="nowLikes">—</span>
          </div>
        </div>
        <button id="btnClose" class="closeBtn">بستن</button>
      </div>

      <div id="playerArea"></div>

      <div class="progressRow">
        <div class="bar"><div id="nowBar"></div></div>
        <div class="percent" id="nowPercent">0%</div>
      </div>

      <div class="motivate" id="motivateLine">یادگیری امروز، سرمایه فرداست.</div>
    </div>
  </div>

  <div id="onboardBackdrop" class="modalBackdrop">
    <div class="modal">
      <h2>تکمیل اطلاعات</h2>
      <p>برای ورود به آکادمی، لطفاً اطلاعات را یک‌بار وارد کنید.</p>

      <div class="formGrid">
        <input id="inpName" class="inp" placeholder="نام و نام خانوادگی" />
        <input id="inpRole" class="inp" placeholder="سمت شغلی" />
        <input id="inpMobile" class="inp" placeholder="شماره موبایل (مثلاً 0912...)" inputmode="tel" />
        <input id="inpDept" class="inp" placeholder="واحد (اختیاری)" />
      </div>

      <div class="modalFooter">
        <button id="btnSaveProfile" class="btnPrimary">ثبت و ورود</button>
      </div>
      <div class="hint" id="onboardErr" style="color:rgba(239,68,68,.95); display:none;"></div>
    </div>
  </div>

<script>
/* =========================
   CONFIG (Supabase)
========================= */
// >>> FILL THESE <<<
// Example:
// const SB_URL = "https://xxxx.supabase.co";
// const SB_ANON_KEY = "eyJhbGciOi...";
// IMPORTANT: use anon key (publishable), NOT service_role.

const SB_URL = "https://szjwrqzgiekjaggqsuoh.supabase.co";
const SB_ANON_KEY = "sb_publishable_hkKIc6r7pSDCJsUvoOafrg_vK8xQc0F";

/* =========================
   Logo (replace anytime)
========================= */
const LOGO_DATA_URI =
  "data:image/svg+xml;utf8," +
  encodeURIComponent(`
  <svg xmlns="http://www.w3.org/2000/svg" width="96" height="96" viewBox="0 0 96 96">
    <defs>
      <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0" stop-color="#22c55e"/>
        <stop offset="1" stop-color="#60a5fa"/>
      </linearGradient>
    </defs>
    <rect width="96" height="96" rx="24" fill="rgba(255,255,255,.06)"/>
    <circle cx="48" cy="48" r="28" fill="url(#g)" opacity="0.95"/>
    <path d="M57 34c-9 2-15 8-17 17-1 6 2 12 8 13 6 1 12-3 14-9 2-5 1-14-5-21z"
          fill="rgba(7,16,35,.92)"/>
    <path d="M41 57c6-6 12-10 19-12" stroke="rgba(7,16,35,.85)" stroke-width="3" stroke-linecap="round"/>
  </svg>`);

/* =========================
   Telegram
========================= */
const tg = window.Telegram?.WebApp;
if (tg) {
  document.body.classList.add("tg");
  try { tg.expand(); } catch(e){}
}

function getTelegramId() {
  try {
    const u = tg?.initDataUnsafe?.user;
    return u?.id || null;
  } catch(e) {
    return null;
  }
}

const TELEGRAM_ID = getTelegramId();

/* =========================
   Utilities
========================= */
function $(id){ return document.getElementById(id); }

function showErr(msg){
  $("onboardErr").textContent = msg;
  $("onboardErr").style.display = "block";
}

function hideErr(){
  $("onboardErr").style.display = "none";
}

function fmtTime(sec){
  sec = Math.max(0, Math.floor(sec||0));
  const m = Math.floor(sec/60);
  const s = sec%60;
  return `${m}:${String(s).padStart(2,"0")}`;
}

function safeText(x){
  if (x == null) return "";
  return String(x);
}

/* =========================
   Simple Supabase REST client
========================= */
async function sFetch(path, opts={}){
  const url = `${SB_URL}/rest/v1/${path}`;
  const headers = Object.assign({
    apikey: SB_ANON_KEY,
    Authorization: `Bearer ${SB_ANON_KEY}`,
    "Content-Type": "application/json",
    "Prefer": "return=representation"
  }, (opts.headers||{}));

  const res = await fetch(url, Object.assign({}, opts, { headers }));
  if (!res.ok) {
    let t = "";
    try{ t = await res.text(); }catch(e){}
    throw new Error(`Supabase error ${res.status}: ${t || res.statusText}`);
  }
  if (res.status === 204) return null;
  return await res.json();
}

async function sGet(path){
  return await sFetch(path, { method: "GET" });
}

async function sPost(table, rows, upsert=false){
  return await sFetch(table, {
    method: "POST",
    headers: {
      "Prefer": upsert ? "resolution=merge-duplicates,return=representation" : "return=representation"
    },
    body: JSON.stringify(rows)
  });
}

async function sPatch(path, body){
  return await sFetch(path, { method: "PATCH", body: JSON.stringify(body) });
}

/* =========================
   State
========================= */
const CATEGORY_MAP = [
  { key:"sales",    name:"فروش",          desc:"فروش و مذاکره B2B" },
  { key:"product",  name:"محصول",         desc:"شناخت محصول و مزیت‌ها" },
  { key:"mindset",  name:"نگرشی",         desc:"نگرش، رشد و فرهنگ سازمانی" },
  { key:"campaign", name:"کمپین",         desc:"کمپین‌سازی و اجرا" },
  { key:"book",     name:"معرفی کتاب",    desc:"خلاصه کتاب‌های کاربردی" },
];

let CURRENT_CATEGORY = null;
let FILTER_TYPE = "all"; // all|audio|video
let SORT_MODE = "smart"; // smart|newest|liked|engaging

let ALL_CONTENTS = [];
let userProfile = null;

let progressByContent = new Map();     // content_id -> {last_position_seconds, completion_percent, updated_at, duration_seconds}
let engagementByContent = new Map();   // content_id -> total active_seconds (all users)
let likeCountByContent = new Map();    // content_id -> count
let likedByMe = new Set();             // content_id

let continueItem = null;

/* =========================
   UI init
========================= */
$("logoImg").src = LOGO_DATA_URI;

/* =========================
   Onboarding (one-time)
========================= */
async function loadUserProfile(){
  const rows = await sGet(`users?select=telegram_id,full_name,job_title,mobile,department&telegram_id=eq.${encodeURIComponent(TELEGRAM_ID)}&limit=1`);
  return rows[0] || null;
}

function showOnboarding(existing){
  $("onboardErr").style.display = "none";

  // Prefill only from existing DB values (NOT from Telegram)
  try{
    $("inpName").value   = (existing?.full_name  || "").toString();
    $("inpRole").value   = (existing?.job_title  || "").toString();
    $("inpMobile").value = (existing?.mobile     || "").toString();
    $("inpDept").value   = (existing?.department || "").toString();
  }catch(e){}

  $("onboardBackdrop").classList.add("show");
}

function hideOnboarding(){
  $("onboardBackdrop").classList.remove("show");
}

function validMobile(x){
  x = (x||"").trim();
  if (!x) return false;
  return /^0\d{10}$/.test(x);
}

$("btnSaveProfile").onclick = async () => {
  const full_name = ($("inpName").value||"").trim();
  const job_title  = ($("inpRole").value||"").trim();
  const mobile     = ($("inpMobile").value||"").trim();
  const department = ($("inpDept").value||"").trim();

  if (!full_name || full_name.length < 3) return showErr("نام و نام خانوادگی را کامل وارد کنید.");
  if (!job_title || job_title.length < 2) return showErr("سمت شغلی را وارد کنید.");
  if (!validMobile(mobile)) return showErr("شماره موبایل معتبر نیست. مثل 0912xxxxxxx");

  try{
    await sPost("users", [{
      telegram_id: TELEGRAM_ID,
      full_name,
      job_title,
      mobile,
      department: department || null,
      updated_at: new Date().toISOString()
    }], true);

    userProfile = await loadUserProfile();
    hideOnboarding();
    await refreshAll();
  }catch(e){
    showErr("ثبت اطلاعات انجام نشد. تنظیمات Supabase را چک کنید.");
    console.error(e);
  }
};

/* =========================
   Category UI
========================= */
function renderCategories(){
  const el = $("catGrid");
  el.innerHTML = "";
  CATEGORY_MAP.forEach(c => {
    const d = document.createElement("div");
    d.className = "catCard";
    d.innerHTML = `
      <div class="catName">${c.name}</div>
      <p class="catDesc">${c.desc}</p>
    `;
    d.onclick = () => selectCategory(c.key);
    el.appendChild(d);
  });
}

function setControlsVisible(v){
  $("controlsBlock").classList.toggle("hidden", !v);
  $("btnChangeCategory").classList.toggle("hidden", !v);
}

$("btnChangeCategory").onclick = () => {
  CURRENT_CATEGORY = null;
  $("categoryGate").classList.remove("hidden");
  $("listArea").classList.add("hidden");
  setControlsVisible(false);
};

/* =========================
   Filters
========================= */
function setFilter(type){
  FILTER_TYPE = type;
  ["f_all","f_audio","f_video"].forEach(id => $(id).classList.remove("active"));
  if (type === "all") $("f_all").classList.add("active");
  if (type === "audio") $("f_audio").classList.add("active");
  if (type === "video") $("f_video").classList.add("active");
  renderList();
}

$("f_all").onclick = () => setFilter("all");
$("f_audio").onclick = () => setFilter("audio");
$("f_video").onclick = () => setFilter("video");

$("sortSel").onchange = () => {
  SORT_MODE = $("sortSel").value;
  renderList();
};

$("q").oninput = () => renderList();

/* =========================
   Data loading
========================= */
function getContentCategoryKey(c){
  return c.category_key || "";
}

async function loadAllContents(){
  ALL_CONTENTS = await sGet("contents?select=id,title,type,duration_seconds,file_path,category_key,created_at&order=id.desc&limit=5000");
}

async function loadMyProgress(){
  progressByContent.clear();
  const rows = await sGet(`progress?select=content_id,last_position_seconds,completion_percent,updated_at,duration_seconds&telegram_id=eq.${encodeURIComponent(TELEGRAM_ID)}&limit=5000`);
  rows.forEach(r => {
    progressByContent.set(r.content_id, r);
  });
}

async function loadLikesAndEngagementFor(ids){
  likeCountByContent.clear();
  engagementByContent.clear();
  likedByMe.clear();

  if (!ids.length) return;

  const inList = ids.join(",");

  const likeCounts = await sGet(`likes?select=content_id&content_id=in.(${inList})`);
  likeCounts.forEach(r => likeCountByContent.set(r.content_id, (likeCountByContent.get(r.content_id)||0)+1));

  const myLikes = await sGet(`likes?select=content_id&telegram_id=eq.${encodeURIComponent(TELEGRAM_ID)}&content_id=in.(${inList})`);
  myLikes.forEach(r => likedByMe.add(r.content_id));

  const eng = await sGet(`progress?select=content_id,active_seconds&content_id=in.(${inList})`);
  eng.forEach(r => engagementByContent.set(r.content_id, (engagementByContent.get(r.content_id)||0) + Number(r.active_seconds||0)));
}

function updateCategoryStats(){
  const allInCat = ALL_CONTENTS.filter(c => getContentCategoryKey(c) === CURRENT_CATEGORY);
  if (!allInCat.length){
    $("catProgress").textContent = "0%";
    $("catProgressHint").textContent = "—";
    return;
  }
  let sum = 0;
  allInCat.forEach(c => {
    sum += Number(progressByContent.get(c.id)?.completion_percent || 0);
  });
  const avg = sum / allInCat.length;
  $("catProgress").textContent = `${avg.toFixed(0)}%`;
  $("catProgressHint").textContent = `${allInCat.length} آموزش در این دسته`;
}

function updateOverallProgress(){
  if (!ALL_CONTENTS.length){
    $("overallProgress").textContent = "0%";
    return;
  }
  let sum = 0;
  ALL_CONTENTS.forEach(c => {
    sum += Number(progressByContent.get(c.id)?.completion_percent || 0);
  });
  const avg = sum / ALL_CONTENTS.length;
  $("overallProgress").textContent = `${avg.toFixed(0)}%`;
}

/* =========================
   Continue item
========================= */
function computeContinue(){
  let best = null;
  for (const c of ALL_CONTENTS){
    const p = progressByContent.get(c.id);
    const pct = Number(p?.completion_percent||0);
    const pos = Number(p?.last_position_seconds||0);
    if (pct > 0 && pct < 100){
      if (!best) best = {c, pct, pos};
      else if (p?.updated_at && best.c && new Date(p.updated_at) > new Date(progressByContent.get(best.c.id)?.updated_at || 0)){
        best = {c, pct, pos};
      }
    }
  }
  continueItem = best;
  if (!best){
    $("continueTitle").textContent = "—";
    $("btnContinue").disabled = true;
    return;
  }
  $("continueTitle").textContent = safeText(best.c.title || "—");
  $("btnContinue").disabled = false;
}

$("btnContinue").onclick = () => {
  if (!continueItem) return;
  openPlayer(continueItem.c.id);
};

/* =========================
   List render
========================= */
function sortContents(arr){
  const a = [...arr];

  if (SORT_MODE === "newest"){
    a.sort((x,y) => {
      const dx = x.created_at ? new Date(x.created_at).getTime() : (x.id||0);
      const dy = y.created_at ? new Date(y.created_at).getTime() : (y.id||0);
      return dy - dx;
    });
    return a;
  }

  if (SORT_MODE === "liked"){
    a.sort((x,y) => (likeCountByContent.get(y.id)||0) - (likeCountByContent.get(x.id)||0));
    return a;
  }

  if (SORT_MODE === "engaging"){
    a.sort((x,y) => (engagementByContent.get(y.id)||0) - (engagementByContent.get(x.id)||0));
    return a;
  }

  a.sort((x,y) => {
    const px = Number(progressByContent.get(x.id)?.completion_percent||0);
    const py = Number(progressByContent.get(y.id)?.completion_percent||0);
    const ix = (px>0 && px<100) ? 1 : 0;
    const iy = (py>0 && py<100) ? 1 : 0;
    if (iy !== ix) return iy - ix;
    const dx = x.created_at ? new Date(x.created_at).getTime() : (x.id||0);
    const dy = y.created_at ? new Date(y.created_at).getTime() : (y.id||0);
    return dy - dx;
  });
  return a;
}

function renderList(){
  const list = $("list");
  list.innerHTML = "";

  const q = ($("q").value||"").trim().toLowerCase();

  let items = ALL_CONTENTS.filter(c => getContentCategoryKey(c) === CURRENT_CATEGORY);

  if (FILTER_TYPE !== "all"){
    items = items.filter(c => c.type === FILTER_TYPE);
  }

  if (q){
    items = items.filter(c => (c.title||"").toLowerCase().includes(q));
  }

  items = sortContents(items);

  if (!items.length){
    list.innerHTML = `<div class="empty">موردی پیدا نشد.</div>`;
    return;
  }

  items.forEach(c => {
    const p = progressByContent.get(c.id);
    const pct = Number(p?.completion_percent||0);
    const likes = likeCountByContent.get(c.id)||0;
    const liked = likedByMe.has(c.id);

    const dur = Number(c.duration_seconds||0);
    const pos = Number(p?.last_position_seconds||0);
    const remaining = dur ? Math.max(0, dur - pos) : 0;

    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <div class="itemHead">
        <div style="min-width:0;">
          <div class="itemTitle">${safeText(c.title||"—")}</div>
          <div class="meta">
            <span class="tag">${c.type === "audio" ? "پادکست" : "ویدیو"}</span>
            <span class="tag">${dur ? fmtTime(dur) : "مدت: —"}</span>
            <span class="tag">لایک: ${likes}</span>
          </div>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
          <button class="likeBtn ${liked ? "liked":""}" data-like="${c.id}">
            ❤ <span>${likes}</span>
          </button>
          <button class="btnPrimary" data-play="${c.id}">پخش</button>
        </div>
      </div>

      <div class="progressRow">
        <div class="bar"><div style="width:${pct.toFixed(0)}%"></div></div>
        <div class="percent">${pct.toFixed(0)}%</div>
      </div>

      <div class="hint">باقی‌مانده: ${dur ? fmtTime(remaining) : "—"}</div>
    `;

    card.querySelectorAll("[data-play]").forEach(b => b.onclick = () => openPlayer(Number(b.getAttribute("data-play"))));
    card.querySelectorAll("[data-like]").forEach(b => b.onclick = () => toggleLike(Number(b.getAttribute("data-like"))));

    list.appendChild(card);
  });

  updateCategoryStats();
}

/* =========================
   Category selection
========================= */
async function selectCategory(key){
  CURRENT_CATEGORY = key;
  $("categoryGate").classList.add("hidden");
  $("listArea").classList.remove("hidden");
  setControlsVisible(true);

  const cat = CATEGORY_MAP.find(x => x.key === key);
  $("catPill").textContent = cat ? `دسته: ${cat.name}` : "—";

  const ids = ALL_CONTENTS.filter(c => getContentCategoryKey(c) === key).map(c => c.id);
  await loadLikesAndEngagementFor(ids);

  renderList();
}

/* =========================
   Likes
========================= */
async function toggleLike(contentId){
  const liked = likedByMe.has(contentId);

  try{
    if (!liked){
      await sPost("likes", [{
        telegram_id: TELEGRAM_ID,
        content_id: contentId,
        created_at: new Date().toISOString()
      }], false);
      likedByMe.add(contentId);
      likeCountByContent.set(contentId, (likeCountByContent.get(contentId)||0)+1);
    } else {
      await sFetch(`likes?telegram_id=eq.${encodeURIComponent(TELEGRAM_ID)}&content_id=eq.${contentId}`, { method:"DELETE" });
      likedByMe.delete(contentId);
      likeCountByContent.set(contentId, Math.max(0,(likeCountByContent.get(contentId)||0)-1));
    }
    renderList();
  }catch(e){
    console.error(e);
  }
}

/* =========================
   Player
========================= */
let currentContent = null;
let currentMediaEl = null;
let lastTick = 0;
let tickTimer = null;

function openPlayer(contentId){
  const c = ALL_CONTENTS.find(x => x.id === contentId);
  if (!c) return;
  currentContent = c;

  $("nowTitle").textContent = safeText(c.title||"—");
  $("nowType").textContent = c.type === "audio" ? "پادکست" : "ویدیو";
  $("nowDuration").textContent = c.duration_seconds ? `مدت: ${fmtTime(c.duration_seconds)}` : "مدت: —";

  const likes = likeCountByContent.get(c.id)||0;
  $("nowLikes").textContent = `لایک: ${likes}`;

  const p = progressByContent.get(c.id);
  const pos = Number(p?.last_position_seconds||0);
  const pct = Number(p?.completion_percent||0);

  updatePlayerProgressUI(pos, pct);

  const area = $("playerArea");
  area.innerHTML = "";

  let el;
  if (c.type === "video"){
    el = document.createElement("video");
    el.setAttribute("playsinline","true");
    el.controls = true;
  } else {
    el = document.createElement("audio");
    el.controls = true;
  }
  el.src = c.file_path;
  el.controlsList = "nodownload";
  el.disablePictureInPicture = true;
  el.preload = "metadata";

  area.appendChild(el);
  currentMediaEl = el;

  el.addEventListener("loadedmetadata", () => {
    if (c.duration_seconds && Number(c.duration_seconds) > 0) return;
    const dur = Math.floor(el.duration || 0);
    if (dur > 0){
      c.duration_seconds = dur;
    }
  });

  el.addEventListener("canplay", () => {
    try{
      if (pos > 0 && pos < (el.duration || 999999)) el.currentTime = pos;
    }catch(e){}
  });

  el.addEventListener("timeupdate", onTick);
  el.addEventListener("play", startTicking);
  el.addEventListener("pause", stopTicking);
  el.addEventListener("ended", () => {
    stopTicking();
    saveProgress(true);
  });

  $("overlay").classList.add("show");
  $("overlay").setAttribute("aria-hidden","false");
  lastTick = Date.now();
}

$("btnClose").onclick = () => closePlayer();
$("overlay").addEventListener("click", (e) => {
  if (e.target.id === "overlay") closePlayer();
});

function closePlayer(){
  if (!currentContent) {
    $("overlay").classList.remove("show");
    $("overlay").setAttribute("aria-hidden","true");
    return;
  }
  try{ saveProgress(false); }catch(e){}
  stopTicking();
  try{
    if (currentMediaEl){
      currentMediaEl.pause();
      currentMediaEl.src = "";
    }
  }catch(e){}
  currentContent = null;
  currentMediaEl = null;

  $("overlay").classList.remove("show");
  $("overlay").setAttribute("aria-hidden","true");

  computeContinue();
  renderList();
  updateOverallProgress();
}

function updatePlayerProgressUI(pos, pct){
  const dur = Number(currentContent?.duration_seconds||0);
  const remaining = dur ? Math.max(0, dur - pos) : 0;
  $("nowRemaining").textContent = dur ? `باقی‌مانده: ${fmtTime(remaining)}` : "باقی‌مانده: —";

  $("nowPercent").textContent = `${pct.toFixed(0)}%`;
  $("nowBar").style.width = `${pct.toFixed(0)}%`;
}

function onTick(){
  if (!currentMediaEl || !currentContent) return;
  const pos = Math.floor(currentMediaEl.currentTime || 0);
  const dur = Number(currentContent.duration_seconds||0) || Math.floor(currentMediaEl.duration||0) || 0;
  const pct = dur ? Math.min(100, (pos/dur)*100) : 0;
  updatePlayerProgressUI(pos, pct);
}

function startTicking(){
  stopTicking();
  lastTick = Date.now();
  tickTimer = setInterval(() => {
    saveProgress(false, true);
  }, 15000);
}
function stopTicking(){
  if (tickTimer){
    clearInterval(tickTimer);
    tickTimer = null;
  }
}

async function saveProgress(forceComplete=false, isTick=false){
  if (!currentMediaEl || !currentContent) return;

  const pos = Math.floor(currentMediaEl.currentTime || 0);
  const dur = Number(currentContent.duration_seconds||0) || Math.floor(currentMediaEl.duration||0) || 0;
  const pct = dur ? Math.min(100, (pos/dur)*100) : 0;
  const completion_percent = forceComplete ? 100 : pct;

  const now = Date.now();
  let activeSeconds = 0;
  if (isTick){
    activeSeconds = Math.max(0, Math.floor((now - lastTick)/1000));
    lastTick = now;
  }

  const payload = [{
    telegram_id: TELEGRAM_ID,
    content_id: currentContent.id,
    last_position_seconds: pos,
    completion_percent: completion_percent,
    duration_seconds: dur || null,
    active_seconds: activeSeconds || 0,
    updated_at: new Date().toISOString()
  }];

  try{
    await sPost("progress", payload, true);
    progressByContent.set(currentContent.id, payload[0]);
  }catch(e){
    console.error(e);
  }
}

/* =========================
   Main
========================= */
async function refreshAll(){
  userProfile = await loadUserProfile();

  // Gate: require manual profile fields before anything else loads
  const needsProfile = (!userProfile
    || !userProfile.full_name
    || !userProfile.job_title
    || !userProfile.mobile);

  if (needsProfile){
    showOnboarding(userProfile || null);
    return;
  }

  await loadAllContents();
  await loadMyProgress();

  updateOverallProgress();
  computeContinue();

  renderCategories();
}

(async function init(){
  if (!SB_URL || !SB_ANON_KEY){
    $("continueHint").style.display = "block";
    $("continueHint").textContent = "تنظیمات Supabase کامل نیست.";
    return;
  }
  if (!TELEGRAM_ID){
    $("continueHint").style.display = "block";
    $("continueHint").textContent = "این مینی‌اپ باید داخل تلگرام باز شود.";
    return;
  }
  await refreshAll();
})();
</script>
</body>
</html>
