<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>آکادمی سیلانه سبز</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1220;
      --card:#0f172a;
      --card2: rgba(15,23,42,.72);
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border: rgba(229,231,235,.12);
      --shadow: 0 14px 34px rgba(0,0,0,.38);
      --primary:#8b5cf6;
      --primary-weak: rgba(139,92,246,.18);
      --success:#22c55e;
      --danger:#ef4444;
      --radius: 22px;
    }

    /* وقتی تلگرام تم روشن بود */
    body.light{
      --bg:#f3f4f6;
      --card:#ffffff;
      --card2: rgba(255,255,255,.88);
      --text:#111827;
      --muted:#4b5563;
      --border: rgba(17,24,39,.12);
      --shadow: 0 16px 34px rgba(17,24,39,.10);
      --primary:#6d28d9;
      --primary-weak: rgba(109,40,217,.12);
    }

    *{ box-sizing:border-box; }
    html, body { height:100%; }
    body{
      margin:0;
      font-family: Vazirmatn, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 700px at 70% -10%, rgba(139,92,246,.14), transparent 60%),
        radial-gradient(1000px 700px at 10% 0%, rgba(34,197,94,.10), transparent 55_optional%),
        var(--bg);
      color: var(--text);
      overflow-x:hidden;
    }

    /* تمام صفحه و بدون نوارهای کناری */
    .app{
      min-height:100vh;
      width: 100%;
      padding: 14px max(12px, env(safe-area-inset-right)) 22px max(12px, env(safe-area-inset-left));
    }

    /* کانتینر اصلی (فول‌ویدث، رند) */
    .sheet{
      width: 100%;
      border-radius: calc(var(--radius) + 6px);
      overflow: hidden;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0));
      box-shadow: var(--shadow);
    }

    .topbar{
      position: sticky;
      top: 0;
      z-index: 10;
      padding: 14px 14px 12px;
      background: linear-gradient(to bottom, rgba(0,0,0,.38), rgba(0,0,0,.18), rgba(0,0,0,0));
      backdrop-filter: blur(10px);
    }
    body.light .topbar{
      background: linear-gradient(to bottom, rgba(255,255,255,.92), rgba(255,255,255,.65), rgba(255,255,255,0));
    }

    .brand{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }

    .brandRight{
      display:flex;
      flex-direction: column;
      min-width: 0;
      text-align: right;
    }

    /* لوگو سمت چپ */
    .brandLeft{
      display:flex;
      align-items:center;
      gap: 10px;
      flex: 0 0 auto;
    }

    .logo{
      width: 42px;
      height: 42px;
      border-radius: 14px;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--border);
      overflow:hidden;
      box-shadow: 0 12px 24px rgba(0,0,0,.22);
    }
    .logo img{ width:100%; height:100%; object-fit:cover; }

    .title{
      margin:0;
      font-size: 24px;
      font-weight: 900;
      letter-spacing: -0.3px;
      line-height: 1.15;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .subtitle{
      margin-top: 6px;
      font-size: 13px;
      color: var(--muted);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .row{
      margin-top: 12px;
      display: grid;
      grid-template-columns: 1fr 260px;
      gap: 10px;
    }
    @media (max-width: 820px){
      .row{ grid-template-columns: 1fr; }
    }

    .search{
      width:100%;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      outline: none;
      font-weight: 700;
    }
    body.light .search{ background: rgba(255,255,255,.92); }
    .search::placeholder{ color: rgba(156,163,175,.95); }

    .seg{
      display:flex;
      border: 1px solid var(--border);
      border-radius: 16px;
      overflow:hidden;
      background: rgba(255,255,255,.06);
    }
    body.light .seg{ background: rgba(255,255,255,.92); }
    .seg button{
      flex:1;
      padding: 10px 10px;
      border:0;
      background: transparent;
      cursor:pointer;
      color: var(--muted);
      font-weight: 900;
      font-family: inherit;
    }
    .seg button.active{
      color: var(--primary);
      background: var(--primary-weak);
    }

    .toolbar{
      margin-top: 10px;
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
      justify-content: space-between;
      padding: 0 14px 12px;
    }

    .btnGhost{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 16px;
      cursor:pointer;
      font-family: inherit;
      font-weight: 900;
    }
    body.light .btnGhost{ background: rgba(255,255,255,.92); }
    .btnGhost:active{ transform: translateY(1px); }

    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-weight: 900;
      font-size: 13px;
      white-space: nowrap;
    }
    body.light .pill{ background: rgba(255,255,255,.92); }

    .content{
      padding: 14px;
    }

    /* Home: کتگوری‌ها */
    .catGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 860px){
      .catGrid{ grid-template-columns: 1fr; }
    }

    .catCard{
      background: var(--card2);
      border: 1px solid var(--border);
      border-radius: 22px;
      padding: 18px;
      box-shadow: var(--shadow);
      cursor:pointer;
      user-select: none;
    }
    .catTitle{
      font-size: 18px;
      font-weight: 900;
      margin: 0 0 6px;
    }
    .catDesc{
      margin:0;
      color: var(--muted);
      font-size: 13px;
      font-weight: 700;
      line-height: 1.6;
    }

    /* لیست محتوا */
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: rgba(0,0,0,.24);
      border: 1px solid var(--border);
      border-radius: 22px;
      padding: 14px;
      box-shadow: var(--shadow);
    }
    body.light .card{
      background: rgba(255,255,255,.92);
    }

    .itemHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 10px;
    }

    .itemTitle{
      margin:0;
      font-size: 18px;
      font-weight: 900;
      line-height: 1.3;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 62%;
    }

    .badge{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      font-weight: 900;
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 13px;
      white-space: nowrap;
    }
    body.light .badge{ background: rgba(255,255,255,.92); }

    .actions{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btnPrimary{
      border: 0;
      background: var(--primary);
      color: white;
      padding: 10px 16px;
      border-radius: 16px;
      cursor:pointer;
      font-family: inherit;
      font-weight: 900;
    }
    .btnPrimary:active{ transform: translateY(1px); }

    .likeBtn{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 16px;
      cursor:pointer;
      font-weight: 900;
      display:flex;
      align-items:center;
      gap: 8px;
    }
    body.light .likeBtn{ background: rgba(255,255,255,.92); }

    .metaRow{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items:center;
      justify-content:flex-end;
      margin-top: 10px;
    }

    .smallPill{
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-weight: 900;
      font-size: 12px;
    }
    body.light .smallPill{ background: rgba(255,255,255,.92); }

    .progressBar{
      margin-top: 12px;
      height: 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.05);
      overflow:hidden;
    }
    body.light .progressBar{ background: rgba(0,0,0,.04); }
    .progressFill{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(34,197,94,.85), rgba(139,92,246,.85));
      border-radius: 999px;
    }

    .empty{
      margin-top: 10px;
      padding: 16px;
      border-radius: 18px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-weight: 900;
      text-align:center;
    }
    body.light .empty{ background: rgba(255,255,255,.92); }

    /* مودال پلیر */
    .modal{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 50;
    }
    .modal.show{ display:flex; }

    .modalCard{
      width: min(920px, 100%);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 22px;
      padding: 14px;
      box-shadow: var(--shadow);
    }
    body.light .modalCard{ background: #fff; }

    .modalTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }

    .modalTitle{
      margin:0;
      font-weight: 900;
      font-size: 16px;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 80%;
    }

    .xBtn{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight: 900;
    }
    body.light .xBtn{ background: rgba(255,255,255,.92); }

    .player{
      width:100%;
      border-radius: 18px;
      overflow:hidden;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.25);
    }
    body.light .player{ background: rgba(0,0,0,.04); }
    audio, video{
      width:100%;
      display:block;
      outline:none;
    }

    /* پنل آپلود ادمین */
    .adminPanel{
      margin: 12px 14px 0;
      padding: 14px;
      border-radius: 22px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.05);
    }
    body.light .adminPanel{ background: rgba(255,255,255,.92); }

    .adminTitle{
      margin:0 0 10px;
      font-weight: 900;
      font-size: 16px;
    }

    .adminForm{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 820px){
      .adminForm{ grid-template-columns: 1fr; }
    }

    .field, .select, .fileInput{
      width:100%;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      outline:none;
      font-family: inherit;
      font-weight: 800;
    }
    body.light .field, body.light .select{ background: rgba(255,255,255,.98); color: var(--text); }
    .hint{
      margin-top: 8px;
      color: var(--muted);
      font-weight: 800;
      font-size: 12px;
      line-height: 1.6;
    }
    .status{
      margin-top: 10px;
      font-weight: 900;
      color: var(--muted);
    }
    .status.err{ color: var(--danger); }
    .hidden{ display:none !important; }
  </style>
</head>

<body>
  <div class="app">
    <div class="sheet">
      <div class="topbar">
        <div class="brand">
          <!-- سمت چپ: لوگو -->
          <div class="brandLeft">
            <div class="logo">
              <img src="logo-light.png" alt="Seylaneh Sabz">
            </div>
            <button id="btnBack" class="btnGhost hidden">تغییر دسته</button>
          </div>

          <!-- سمت راست: فقط متن (بدون باکس اضافه) -->
          <div class="brandRight">
            <h1 class="title">آکادمی سیلانه سبز</h1>
            <div class="subtitle">یادگیری مستمر، مزیت رقابتی ما</div>
          </div>
        </div>

        <div class="row">
          <input id="q" class="search" placeholder="جستجو در آموزش‌ها (مثلاً فروش، محصول، ...)" />
          <div class="seg">
            <button id="tabAll" class="active">همه</button>
            <button id="tabAudio">پادکست</button>
            <button id="tabVideo">ویدیو</button>
          </div>
        </div>

        <div class="toolbar">
          <div class="pill" id="pillCat">دسته: —</div>
          <div class="pill" id="pillUser">کاربر: —</div>
        </div>

        <!-- پنل ادمین -->
        <div id="adminUpload" class="adminPanel hidden">
          <div class="adminTitle">آپلود محتوا (ادمین)</div>

          <div class="adminForm">
            <input id="upTitle" class="field" placeholder="عنوان محتوا" />

            <select id="upCategory" class="select">
              <option value="sales">آموزش فروش</option>
              <option value="product">آموزش محصول</option>
              <option value="campaign">آموزش کمپین</option>
              <option value="mindset">نگرشی</option>
              <option value="book">خلاصه کتاب</option>
            </select>

            <input id="upFile" class="field" type="file" accept="audio/*,video/*" />
            <input id="upDurationManual" class="field hidden" placeholder="اگر مدت تشخیص داده نشد: مدت زمان (ثانیه)" inputmode="numeric" />

            <button id="btnUpload" class="btnPrimary" type="button">آپلود و ثبت</button>
            <div class="hint" id="upHint">فایل را انتخاب کن؛ سیستم مدت را خودکار درمی‌آورد. اگر نشد، فیلد دستی فعال می‌شود.</div>
          </div>

          <div id="upStatus" class="status"></div>
        </div>
      </div>

      <div class="content" id="viewHome">
        <div class="catGrid" id="cats"></div>
      </div>

      <div class="content hidden" id="viewList">
        <div class="grid" id="list"></div>
        <div class="empty hidden" id="emptyList">در این دسته هنوز محتوایی ثبت نشده.</div>
      </div>
    </div>
  </div>

  <!-- Modal Player -->
  <div id="modal" class="modal">
    <div class="modalCard">
      <div class="modalTop">
        <h3 id="modalTitle" class="modalTitle">—</h3>
        <button id="closeModal" class="xBtn">بستن</button>
      </div>
      <div class="player" id="playerBox"></div>
    </div>
  </div>

  <script>
    /***********************
     *  CONFIG (تو پر کن)
     ***********************/
    const SUPABASE_URL = "PASTE_SUPABASE_URL_HERE";
    const SUPABASE_ANON_KEY = "PASTE_SUPABASE_ANON_KEY_HERE";
    const BUCKET = "training-media";
    const ADMIN_IDS = new Set([193158792, 6545251601]);

    /***********************
     *  STATE
     ***********************/
    let tgUser = null;
    let CURRENT_CATEGORY = null;
    let CURRENT_TAB = "all"; // all|audio|video
    let ALL_CONTENTS = [];
    let LIKE_MAP = new Map(); // content_id -> count
    let USER_LIKES = new Set(); // content_id
    let UPLOADING_LOCK = false;
    let ADMIN_UPLOAD_INITED = false;

    const CATS = [
      { key:"sales",   title:"آموزش فروش",   desc:"مهارت‌های مذاکره، پیگیری، بستن فروش" },
      { key:"product", title:"آموزش محصول", desc:"دانش محصول، مزایا، تفاوت‌ها و کاربردها" },
      { key:"mindset", title:"نگرشی",       desc:"تفکر، انگیزه، مدیریت زمان، رشد فردی" },
      { key:"campaign",title:"آموزش کمپین",  desc:"کمپین‌سازی، اجرا، KPI و تحلیل" },
      { key:"book",    title:"خلاصه کتاب",  desc:"چکیده‌های کاربردی برای تصمیم‌گیری بهتر" }
    ];

    /***********************
     *  HELPERS
     ***********************/
    const $ = (id) => document.getElementById(id);
    const show = (el) => el.classList.remove("hidden");
    const hide = (el) => el.classList.add("hidden");

    function detectLightFromColor(hex){
      if (!hex || typeof hex !== "string") return false;
      const m = hex.replace("#","").trim();
      if (m.length !== 6) return false;
      const r = parseInt(m.slice(0,2),16);
      const g = parseInt(m.slice(2,4),16);
      const b = parseInt(m.slice(4,6),16);
      const luminance = (0.2126*r + 0.7152*g + 0.0722*b) / 255;
      return luminance > 0.65;
    }

    function initTheme(){ /* disabled to keep UI stable across themes */ }

    function initTelegram(){
      try{
        const WebApp = window.Telegram?.WebApp;
        if (WebApp){
          WebApp.ready();
          WebApp.expand();
          tgUser = WebApp.initDataUnsafe?.user || null;
        }
      }catch(e){}
      if (!tgUser){
        // fallback ساده (داخل مرورگر)
        tgUser = { id: 0, first_name: "Guest" };
      }
      $("pillUser").textContent = "کاربر: " + (tgUser.first_name || "—");
    }

    function isAdmin(){
      const id = Number(tgUser?.id || 0);
      return ADMIN_IDS.has(id);
    }

    function setUploadBusy(isBusy){
      const btn = $("btnUpload");
      if (!btn) return;
      btn.disabled = isBusy;
      btn.style.opacity = isBusy ? "0.65" : "1";
      btn.style.pointerEvents = isBusy ? "none" : "auto";
      btn.textContent = isBusy ? "در حال آپلود..." : "آپلود و ثبت";
    }

    function showUploadStatus(msg, isErr=false){
      const el = $("upStatus");
      if (!el) return;
      el.textContent = msg || "";
      el.classList.toggle("err", !!isErr);
    }

    function fmtDuration(seconds){
      const s = Math.max(0, Number(seconds||0));
      const m = Math.floor(s/60);
      const r = s%60;
      return `${m}:${String(r).padStart(2,"0")}`;
    }

    function detectType(file){
      const t = (file?.type || "").toLowerCase();
      if (t.startsWith("video/")) return "video";
      return "audio";
    }

    // اسم فایل امن (بدون فارسی/فاصله) => مشکل 400/encoding بسته میشه
    function safeUploadPath(file){
      const ext = (file.name.split(".").pop() || "").toLowerCase().replace(/[^a-z0-9]/g,"") || (detectType(file)==="video" ? "mp4" : "m4a");
      const ts = Date.now();
      const rnd = Math.random().toString(16).slice(2);
      return `uploads/${ts}_${rnd}.${ext}`;
    }

    async function getDurationFromFile(file){
      return new Promise((resolve) => {
        try{
          const url = URL.createObjectURL(file);
          const type = detectType(file);
          const el = document.createElement(type === "video" ? "video" : "audio");
          el.preload = "metadata";
          el.onloadedmetadata = () => {
            const d = el.duration;
            URL.revokeObjectURL(url);
            if (Number.isFinite(d) && d > 0) resolve(Math.floor(d));
            else resolve(null);
          };
          el.onerror = () => {
            URL.revokeObjectURL(url);
            resolve(null);
          };
          el.src = url;
        }catch(e){
          resolve(null);
        }
      });
    }

    function headersJson(){
      return {
        "apikey": SUPABASE_ANON_KEY,
        "Authorization": "Bearer " + SUPABASE_ANON_KEY,
        "Content-Type": "application/json",
        "Prefer": "return=representation"
      };
    }

    async function sGet(path){
      const res = await fetch(`${SUPABASE_URL}/rest/v1/${path}`, {
        method: "GET",
        headers: {
          "apikey": SUPABASE_ANON_KEY,
          "Authorization": "Bearer " + SUPABASE_ANON_KEY
        }
      });
      if (!res.ok) throw new Error(`GET failed: ${res.status}`);
      return await res.json();
    }

    async function sPost(table, payload){
      const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}`, {
        method:"POST",
        headers: headersJson(),
        body: JSON.stringify(payload)
      });
      if (!res.ok){
        const t = await res.text().catch(()=> "");
        throw new Error(`POST ${table} failed: ${res.status} ${t}`);
      }
      return await res.json();
    }

    async function uploadToStorage(file){
      const path = safeUploadPath(file);

      const res = await fetch(`${SUPABASE_URL}/storage/v1/object/${BUCKET}/${encodeURIComponent(path).replaceAll("%2F","/")}`, {
        method: "POST", // Supabase Storage upload endpoint supports POST
        headers: {
          "apikey": SUPABASE_ANON_KEY,
          "Authorization": "Bearer " + SUPABASE_ANON_KEY,
          "x-upsert": "true"
        },
        body: (() => {
          // multipart/form-data: بهترین حالت برای سازگاری
          const fd = new FormData();
          fd.append("file", file);
          return fd;
        })()
      });

      if (!res.ok){
        const t = await res.text().catch(()=> "");
        throw new Error(`Storage upload failed: ${res.status} ${t}`);
      }

      const publicUrl = `${SUPABASE_URL}/storage/v1/object/public/${BUCKET}/${path}`;
      return { publicUrl, path };
    }

    async function insertContentRow({title, type, category_key, file_url, duration_seconds, client_request_id}){
      const row = {
        title,
        type,
        category_key,
        file_path: file_url,
        duration_seconds: Number(duration_seconds || 0),
        client_request_id: client_request_id || null
      };
      // اگر ستون client_request_id هنوز نداری، مشکلی نیست—Supabase آن را نادیده نمی‌گیرد؟ (اگر نبود خطا می‌دهد)
      // پس برای سازگاری، اگر خطا داد دوباره بدون آن می‌زنیم:
      try{
        await sPost("contents", row);
      }catch(e){
        const msg = String(e.message || e);
        if (msg.includes("client_request_id")){
          delete row.client_request_id;
          await sPost("contents", row);
          return;
        }
        throw e;
      }
    }

    /***********************
     *  UI RENDER
     ***********************/
    function renderCats(){
      const box = $("cats");
      box.innerHTML = "";
      CATS.forEach(c => {
        const div = document.createElement("div");
        div.className = "catCard";
        div.innerHTML = `
          <div class="catTitle">${c.title}</div>
          <p class="catDesc">${c.desc}</p>
        `;
        div.onclick = () => openCategory(c.key);
        box.appendChild(div);
      });
    }

    function setCategoryPill(){
      const cat = CATS.find(x => x.key === CURRENT_CATEGORY);
      $("pillCat").textContent = "دسته: " + (cat ? cat.title : "—");
    }

    function openCategory(key){
      CURRENT_CATEGORY = key;
      setCategoryPill();
      hide($("viewHome"));
      show($("viewList"));
      show($("btnBack"));
      renderList();
    }

    function backToHome(){
      CURRENT_CATEGORY = null;
      setCategoryPill();
      show($("viewHome"));
      hide($("viewList"));
      hide($("btnBack"));
      $("q").value = "";
      CURRENT_TAB = "all";
      setTabsUI();
      renderCats();
    }

    function setTabsUI(){
      $("tabAll").classList.toggle("active", CURRENT_TAB==="all");
      $("tabAudio").classList.toggle("active", CURRENT_TAB==="audio");
      $("tabVideo").classList.toggle("active", CURRENT_TAB==="video");
    }

    function filterContents(){
      const q = ($("q").value || "").trim().toLowerCase();
      let arr = ALL_CONTENTS;

      if (CURRENT_CATEGORY){
        arr = arr.filter(x => x.category_key === CURRENT_CATEGORY);
      }
      if (CURRENT_TAB !== "all"){
        arr = arr.filter(x => x.type === CURRENT_TAB);
      }
      if (q){
        arr = arr.filter(x => (x.title || "").toLowerCase().includes(q));
      }
      return arr;
    }

    function renderList(){
      const list = $("list");
      const empty = $("emptyList");
      const items = filterContents();

      list.innerHTML = "";
      if (!items.length){
        show(empty);
        return;
      }
      hide(empty);

      items.forEach(it => {
        const card = document.createElement("div");
        card.className = "card";

        const likesCount = LIKE_MAP.get(it.id) || 0;
        const liked = USER_LIKES.has(it.id);

        card.innerHTML = `
          <div class="itemHead">
            <div class="actions">
              <button class="btnPrimary" data-play="${it.id}">پخش</button>
              <button class="likeBtn" data-like="${it.id}">
                <span>${liked ? "♥" : "♡"}</span>
                <span>${likesCount}</span>
              </button>
            </div>

            <div style="text-align:left;">
              <h4 class="itemTitle" title="${(it.title||"").replaceAll('"','')}">${it.title || "—"}</h4>
              <div class="metaRow">
                <span class="smallPill">${it.type === "video" ? "ویدیو" : "پادکست"}</span>
                <span class="smallPill">مدت ${fmtDuration(it.duration_seconds)}</span>
              </div>
            </div>
          </div>

          <div class="progressBar">
            <div class="progressFill" id="pf_${it.id}" style="width:0%"></div>
          </div>
        `;

        card.querySelector(`[data-play="${it.id}"]`).onclick = () => openPlayer(it);
        card.querySelector(`[data-like="${it.id}"]`).onclick = () => toggleLike(it.id);

        list.appendChild(card);
      });
    }

    /***********************
     *  PLAYER + LISTEN EVENT (حداقلی)
     ***********************/
    let activeMediaEl = null;
    let activeContent = null;

    function closePlayer(){
      if (activeMediaEl){
        try{ activeMediaEl.pause(); }catch(e){}
      }
      activeMediaEl = null;
      activeContent = null;
      $("playerBox").innerHTML = "";
      hideModal();
    }

    function showModal(){
      $("modal").classList.add("show");
    }
    function hideModal(){
      $("modal").classList.remove("show");
    }

    async function logListenEvent(contentId, eventType){
      try{
        await sPost("listen_events", [{
          telegram_id: Number(tgUser?.id || 0),
          content_id: Number(contentId),
          event_type: eventType,
          occurred_at: new Date().toISOString()
        }]);
      }catch(e){
        // silent (MVP)
      }
    }

    function openPlayer(item){
      activeContent = item;
      $("modalTitle").textContent = item.title || "—";
      $("playerBox").innerHTML = "";

      const type = item.type;
      const src = item.file_path;

      if (type === "video"){
        const v = document.createElement("video");
        v.src = src;
        v.controls = true;
        v.playsInline = false; // فول‌اسکرین بهتر
        v.preload = "metadata";
        v.onplay = () => logListenEvent(item.id, "play");
        v.onpause = () => logListenEvent(item.id, "pause");
        v.onended = () => logListenEvent(item.id, "ended");
        $("playerBox").appendChild(v);
        activeMediaEl = v;
      } else {
        const a = document.createElement("audio");
        a.src = src;
        a.controls = true;
        a.preload = "metadata";
        a.onplay = () => logListenEvent(item.id, "play");
        a.onpause = () => logListenEvent(item.id, "pause");
        a.onended = () => logListenEvent(item.id, "ended");
        $("playerBox").appendChild(a);
        activeMediaEl = a;
      }

      showModal();
    }

    /***********************
     *  LIKES (MVP)
     ***********************/
    async function refreshLikes(){
      // برای MVP ساده: فقط شمارش لایک‌ها
      try{
        const rows = await sGet("likes?select=content_id");
        LIKE_MAP = new Map();
        rows.forEach(r => {
          const id = Number(r.content_id);
          LIKE_MAP.set(id, (LIKE_MAP.get(id)||0) + 1);
        });
      }catch(e){
        LIKE_MAP = new Map();
      }
    }

    async function refreshUserLikes(){
      try{
        const uid = Number(tgUser?.id || 0);
        const rows = await sGet(`likes?select=content_id&telegram_id=eq.${uid}`);
        USER_LIKES = new Set(rows.map(r => Number(r.content_id)));
      }catch(e){
        USER_LIKES = new Set();
      }
    }

    async function toggleLike(contentId){
      const uid = Number(tgUser?.id || 0);
      const id = Number(contentId);

      try{
        if (USER_LIKES.has(id)){
          // delete like
          const res = await fetch(`${SUPABASE_URL}/rest/v1/likes?telegram_id=eq.${uid}&content_id=eq.${id}`, {
            method:"DELETE",
            headers:{
              "apikey": SUPABASE_ANON_KEY,
              "Authorization": "Bearer " + SUPABASE_ANON_KEY
            }
          });
          if (!res.ok) throw new Error("delete failed");
        } else {
          await sPost("likes", [{ telegram_id: uid, content_id: id }]);
        }
        await refreshAll(true);
      }catch(e){
        console.error(e);
      }
    }

    /***********************
     *  DATA LOAD + DEDUP
     ***********************/
    async function refreshAll(silent=false){
      try{
        if (!silent) {}

        ALL_CONTENTS = await sGet("contents?select=id,title,type,duration_seconds,file_path,category_key,created_at&order=id.desc&limit=5000");

        // ✅ De-dup: حتی اگر چند رکورد تکراری ساختی، فقط یکی نمایش داده می‌شود
        const seen = new Set();
        ALL_CONTENTS = ALL_CONTENTS.filter(c => {
          const key = (c.file_path || "") + "|" + (c.title || "") + "|" + (c.duration_seconds || 0);
          if (seen.has(key)) return false;
          seen.add(key);
          return true;
        });

        await refreshLikes();
        await refreshUserLikes();

        if (CURRENT_CATEGORY) renderList();
      }catch(e){
        console.error("refreshAll error", e);
      }
    }

    /***********************
     *  ADMIN UPLOAD (FIX DUPLICATE)
     ***********************/
    function initAdminUpload(){
      const panel = $("adminUpload");
      if (!panel) return;
      if (isAdmin()) show(panel); else hide(panel);
      if (ADMIN_UPLOAD_INITED) return;
      ADMIN_UPLOAD_INITED = true;

      $("upFile")?.addEventListener("change", async () => {
        const file = $("upFile").files?.[0];
        $("upDurationManual").classList.add("hidden");
        $("upDurationManual").value = "";
        $("upDurationManual").dataset.auto = "";
        if (!file) return;

        $("upHint").textContent = "در حال استخراج مدت زمان از فایل...";
        const dur = await getDurationFromFile(file);

        if (dur && dur > 0){
          $("upHint").textContent = `مدت زمان شناسایی شد: ${dur} ثانیه`;
          $("upDurationManual").classList.add("hidden");
          $("upDurationManual").dataset.auto = String(dur);
        } else {
          $("upHint").textContent = "مدت زمان از فایل قابل استخراج نبود. لطفاً مدت را دستی (ثانیه) وارد کن.";
          $("upDurationManual").classList.remove("hidden");
        }
      }, { passive: true });

      $("btnUpload")?.addEventListener("click", async () => {
        if (UPLOADING_LOCK) return; // ✅ جلوگیری از کلیک چندباره
        UPLOADING_LOCK = true;
        setUploadBusy(true);
        showUploadStatus("");

        try{
          const title = ($("upTitle").value || "").trim();
          const category_key = $("upCategory").value;
          const file = $("upFile").files?.[0];

          if (!title) throw new Error("عنوان را وارد کن.");
          if (!file) throw new Error("فایل را انتخاب کن.");

          // ✅ جلوگیری از آپلود/ثبت تکراری (بعضی WebViewها یک کلیک را چندبار تریگر می‌کنند)
          const sig = `${title}|${category_key}|${file.size}|${file.lastModified}`;
          const sigKey = 'ss_academy_last_upload_sig';
          const tsKey  = 'ss_academy_last_upload_ts';
          const lastSig = localStorage.getItem(sigKey);
          const lastTs  = Number(localStorage.getItem(tsKey) || 0);
          const nowTs = Date.now();
          if (lastSig === sig && (nowTs - lastTs) < 30000){
            showUploadStatus("⚠️ این فایل همین الان ثبت شده؛ از ثبت تکراری جلوگیری شد.", true);
            return;
          }
          // موقتاً امضا را ثبت می‌کنیم؛ اگر خطا شد در catch پاک می‌کنیم
          localStorage.setItem(sigKey, sig);
          localStorage.setItem(tsKey, String(nowTs));

          let duration_seconds = Number($("upDurationManual").dataset.auto || 0);
          if (!duration_seconds || duration_seconds <= 0){
            const manual = Number(($("upDurationManual").value || "").trim());
            if (!manual || manual <= 0) throw new Error("مدت زمان مشخص نیست. عدد ثانیه را دستی وارد کن.");
            duration_seconds = Math.floor(manual);
          }

          const type = detectType(file);

          // ✅ شناسه یکتا (برای آینده اگر unique index گذاشتی)
          const requestId = `${Date.now()}_${Math.random().toString(16).slice(2)}`;

          showUploadStatus("در حال آپلود فایل به Storage...");
          const { publicUrl } = await uploadToStorage(file);

          showUploadStatus("آپلود انجام شد. در حال ثبت در جدول contents...");
          await insertContentRow({
            title,
            type,
            category_key,
            file_url: publicUrl,
            duration_seconds,
            client_request_id: requestId
          });

          showUploadStatus("✅ ثبت شد. در حال ریفرش لیست...");
          await refreshAll(true);

          // پاکسازی فرم
          $("upTitle").value = "";
          $("upFile").value = "";
          $("upDurationManual").value = "";
          $("upDurationManual").dataset.auto = "";
          $("upDurationManual").classList.add("hidden");
          $("upHint").textContent = "فایل را انتخاب کن؛ سیستم مدت را خودکار درمی‌آورد. اگر نشد، فیلد دستی فعال می‌شود.";

          // اگر داخل دسته‌ای هستی، لیست هم آپدیت می‌شود
          if (CURRENT_CATEGORY) renderList();

        }catch(e){
          try{ localStorage.removeItem("ss_academy_last_upload_sig"); localStorage.removeItem("ss_academy_last_upload_ts"); }catch(_){}
          console.error("UPLOAD/INSERT ERROR:", e);
          showUploadStatus("❌ خطا: " + (e?.message || String(e)), true);
        }finally{
          UPLOADING_LOCK = false;
          setUploadBusy(false);
        }
      });
    }

    /***********************
     *  EVENTS
     ***********************/
    $("tabAll").onclick = () => { CURRENT_TAB="all"; setTabsUI(); if (CURRENT_CATEGORY) renderList(); };
    $("tabAudio").onclick = () => { CURRENT_TAB="audio"; setTabsUI(); if (CURRENT_CATEGORY) renderList(); };
    $("tabVideo").onclick = () => { CURRENT_TAB="video"; setTabsUI(); if (CURRENT_CATEGORY) renderList(); };

    $("q").addEventListener("input", () => { if (CURRENT_CATEGORY) renderList(); }, { passive:true });

    $("btnBack").onclick = backToHome;

    $("closeModal").onclick = closePlayer;
    $("modal").onclick = (e) => { if (e.target === $("modal")) closePlayer(); };

    /***********************
     *  BOOT
     ***********************/
    (async function boot(){
      initTheme();
      initTelegram();
      // Supabase keys check removed (no popup)

      renderCats();
      setCategoryPill();
      initAdminUpload();
      await refreshAll(true);
    })();
  </script>
</body>
</html>
