<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Ø¢Ú©Ø§Ø¯Ù…ÛŒ Ø³ÛŒÙ„Ø§Ù†Ù‡ Ø³Ø¨Ø²</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.1/dist/umd/supabase.min.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --page-max: 980px;
      --page-pad: 16px;

      --bg: #f5f7fb;
      --card: rgba(255,255,255,.92);
      --text: #0b1220;
      --muted: #4b5563;
      --border: rgba(15,23,42,.10);
      --shadow: 0 10px 26px rgba(15,23,42,.10);
      --primary: #2563eb;
      --primary-weak: rgba(37,99,235,.12);
      --success:#16a34a;
      --danger:#dc2626;

      --radius: 18px;
      --page-radius: 26px;
    }

    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b1220;
        --card: rgba(15,23,42,.82);
        --text:#e5e7eb;
        --muted:#9ca3af;
        --border: rgba(229,231,235,.10);
        --shadow: 0 10px 26px rgba(0,0,0,.35);
        --primary:#60a5fa;
        --primary-weak: rgba(96,165,250,.14);
        --success:#22c55e;
        --danger:#ef4444;
      }
    }

    body.tg{
      --bg: var(--tg-theme-bg-color, var(--bg));
      --card: var(--tg-theme-secondary-bg-color, var(--card));
      --text: var(--tg-theme-text-color, var(--text));
      --muted: var(--tg-theme-hint-color, var(--muted));
      --primary: var(--tg-theme-button-color, var(--primary));
    }

    *{ box-sizing: border-box; }
    html, body{ height: 100%; }

    body{
      margin:0;
      font-family: Vazirmatn, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: var(--bg);
      color: var(--text);
      overflow-x:hidden;
    }

    body::before{ display:none; }
    
    .wrap{
      max-width: var(--page-max);
      margin: 0 auto;
      padding: 18px var(--page-pad) 28px;
    }
    @media (max-width: 700px){
      .wrap{ max-width: 100%; padding-left: 10px; padding-right: 10px; }
    }

    .topbar{
      position: sticky;
      top: 0;
      z-index: 10;
      padding: 14px 12px 10px;
      border-radius: 22px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.62);
      transition: opacity .18s ease, transform .18s ease;

}
    body.in-cat .topbar{
      position: static !important;
      top: auto !important;
      transform: none !important;
      opacity: 1 !important;
    }

    .topbar.hideTopbar{opacity:0; transform: translateY(-120%); pointer-events:none; background: transparent !important; border-color: transparent !important; box-shadow:none !important; overflow:hidden; max-height:0; padding-top:0; padding-bottom:0; margin-top:0; margin-bottom:0; }
    .topbar.goneTopbar{display:none !important;}

    @media (prefers-color-scheme: dark){
      .topbar{ background: rgba(11,18,32,.72); }
    }
    body.tg .topbar{
      background: color-mix(in srgb, var(--tg-theme-bg-color, #0b1220) 70%, transparent);
    }

    /* âœ… Ù‡Ø¯Ø± Ø¬Ø¯ÛŒØ¯:
       - Ø³Ù…Øª Ø±Ø§Ø³Øª: Ù…ØªÙ† (ØªÙ…Ø§Ù…â€ŒØ¹Ø±Ø¶ Ùˆ Ø®ÙˆØ§Ù†Ø§)
       - Ø³Ù…Øª Ú†Ù¾: Ù„ÙˆÚ¯Ùˆ
       - Ù‡ÛŒÚ† Ø¨Ø§Ú©Ø³ Ø§Ø¶Ø§ÙÛŒ Ø³Ù…Øª Ø±Ø§Ø³Øª Ù†Ø¯Ø§Ø±ÛŒÙ…
    */
    .brand{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .brandText{
      flex: 1 1 auto;
      min-width: 0;
      text-align: right;
    }
    .brandActions{
      display:flex;
      align-items:center;
      gap: 10px;
      flex: 0 0 auto;
    }

    .title{
      font-size: 22px;
      font-weight: 900;
      letter-spacing: -0.3px;
      margin: 0;
      line-height: 1.2;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .subtitle{
      margin-top: 6px;
      font-size: 13px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .logo{
      width: 44px;
      height: 44px;
      border-radius: 14px;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      flex: 0 0 auto;
      box-shadow: 0 10px 20px rgba(0,0,0,.12);
    }
    .logo img{ width: 100%; height: 100%; object-fit: cover; display:block; }

    .btnGhost{
      touch-action: manipulation;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.50);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-family: inherit;
      font-weight: 900;
white-space: nowrap;
    }
    @media (prefers-color-scheme: dark){
      .btnGhost{
      touch-action: manipulation; background: rgba(255,255,255,.04); }
    }
    .btnGhost:active{ transform: translateY(1px); }

    .controls{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    @media (max-width: 700px){
      .controls{ grid-template-columns: 1fr; }
    }

    .search{
      width:100%;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.55);
      color: var(--text);
      outline: none;
box-shadow: 0 1px 0 rgba(0,0,0,.02);
    }
    @media (prefers-color-scheme: dark){
      .search{ background: rgba(255,255,255,.04); }
    }
    .search::placeholder{ color: color-mix(in srgb, var(--muted) 70%, transparent); }
    @media (prefers-color-scheme: dark){
    }

    .toolbar{
      margin-top: 10px;
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
      justify-content: space-between;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.55);
      color: var(--muted);
      font-weight: 800;
      font-size: 13px;
      white-space: nowrap;
}
    @media (prefers-color-scheme: dark){
      .pill{ background: rgba(255,255,255,.05); }
    }

    .select{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.55);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      font-family: inherit;
      font-weight: 900;
      outline:none;
      min-width: 220px;
}
    @media (prefers-color-scheme: dark){
      .select{ background: rgba(255,255,255,.04); }
    }

    .grid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 860px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding: 14px;
}

    .itemHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
    }
    .itemTitle{
      font-weight: 900;
      margin: 0 0 6px;
      font-size: 16px;
      line-height: 1.4;
    }

    .meta{
      font-size: 13px;
      color: var(--muted);
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
    }

    .tag{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.55);
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
}
    @media (prefers-color-scheme: dark){
      .tag{ background: rgba(255,255,255,.05); }
    }

    .btnPrimary{
      border: 0;
      border-radius: 16px;
      padding: 10px 14px;
      cursor:pointer;
      background: var(--primary);
      color: #071023;
      font-weight: 900;
      font-family: inherit;
      white-space: nowrap;
      box-shadow: 0 12px 22px rgba(96,165,250,.18);
    }
    body.tg .btnPrimary{
      color: var(--tg-theme-button-text-color, #071023);
    }
    .btnPrimary:active{ transform: translateY(1px); }

    .likeBtn{
      touch-action: manipulation;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.50);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 16px;
      cursor:pointer;
      font-family: inherit;
      font-weight: 900;
      display:inline-flex;
      gap: 8px;
      align-items:center;
}
    @media (prefers-color-scheme: dark){
      .likeBtn{
      touch-action: manipulation; background: rgba(255,255,255,.04); }
    }
    .likeBtn.liked{
      border-color: color-mix(in srgb, var(--primary) 45%, transparent);
      background: color-mix(in srgb, var(--primary) 14%, transparent);
      color: var(--primary);
    }

    .progressRow{
      margin-top: 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .bar{
      flex:1;
      height: 10px;
      border-radius: 999px;
      background: rgba(156,163,175,.16);
      overflow:hidden;
      border: 1px solid var(--border);
    }
    .bar > div{
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--primary), var(--success));
      border-radius: 999px;
      transition: width .25s ease;
    }
    .percent{
      font-weight: 900;
      color: var(--text);
      min-width: 44px;
      text-align:left;
    }

    .catGrid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    @media (max-width: 700px){
      .catGrid{ grid-template-columns: 1fr; }
    }
    .catCard{
      padding: 16px;
      border-radius: 22px;
      border: 1px solid var(--border);
      background: var(--card);
      cursor: pointer;
      box-shadow: var(--shadow);
}
    .catCard:active{ transform: translateY(1px); }
    .catName{
      font-size: 16px;
      font-weight: 900;
      margin: 0 0 6px;
    }
    .catDesc{
      margin: 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.6;
    }

    .hint{
      margin-top: 10px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.7;
    }

    .empty{
      margin-top: 12px;
      padding: 18px;
      text-align:center;
      color: var(--muted);
    }

    .overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 9999;
    }
    .overlay.show{ display:flex; }
    .playerModal{
      width: min(980px, 96vw);
      max-height: 92vh;
      overflow:auto;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 22px;
      box-shadow: 0 24px 60px rgba(0,0,0,.30);
      padding: 16px;
}
    @media (prefers-color-scheme: dark){
      .playerModal{ box-shadow: 0 24px 60px rgba(0,0,0,.45); }
    }

    .playerHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
    }
    .playerTitle{
      margin:0;
      font-size: 16px;
      font-weight: 900;
      line-height: 1.5;
    }

    .closeBtn{
      touch-action: manipulation;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.50);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-family: inherit;
      font-weight: 900;
white-space: nowrap;
    }
    @media (prefers-color-scheme: dark){
      .closeBtn{
      touch-action: manipulation; background: rgba(255,255,255,.04); }
    }

    video,audio{
      width:100%;
      border-radius: 16px;
      outline:none;
      background: rgba(0,0,0,.25);
      margin-top: 12px;
    }

    .motivate{
      margin-top: 10px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.7;
    }

    .muted{ color: var(--muted); }
    .hidden{ display:none !important; }

    .inp{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.55);
      color: var(--text);
      outline:none;
      font-family: inherit;
      font-weight: 700;
}
    @media (prefers-color-scheme: dark){
      .inp{ background: rgba(255,255,255,.04); }
    }

    .formGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 560px){
      .formGrid{ grid-template-columns: 1fr; }
    }
  
    /* ===== iOS Telegram WebView fixes (Patch-level) ===== */
    body.ios .topbar,
    body.ios .card,
    body.ios .catCard,
    body.ios .playerModal,
    body.ios .pill,
    body.ios .seg,
    body.ios .search,
    body.ios .select,
    body.ios .btnGhost,
    body.ios .likeBtn,
    body.ios .closeBtn{
      touch-action: manipulation;
      backdrop-filter: none !important;
      -webkit-backdrop-filter: none !important;
    }

    /* Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² artifact Ù‡Ø§ÛŒ Blur Ø¯Ø± iOS */
    body.ios .topbar{ background: rgba(255,255,255,.78); }
    @media (prefers-color-scheme: dark){
      body.ios .topbar{ background: rgba(11,18,32,.78); }
    }

    /* Ù„Ù…Ø³ Ø¨Ù‡ØªØ± Ø±ÙˆÛŒ iOS/Android */
    .btnGhost,.btnPrimary,.likeBtn,.closeBtn{
      touch-action: manipulation; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }

    /* ÙˆÙ‚ØªÛŒ Ù¾Ù„ÛŒØ± Ø¨Ø§Ø²Ù‡ØŒ Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ø¯Ù†Ù‡ Ù‚ÙÙ„ Ø´ÙˆØ¯ */
    body.modal-open{ overflow: hidden; }

  
    /* iOS WebView fullscreen quirks:
       ÙˆÙ‚ØªÛŒ ÙˆÛŒØ¯ÛŒÙˆ ÙˆØ§Ø±Ø¯ fullscreen native iOS Ù…ÛŒâ€ŒØ´ÙˆØ¯ØŒ UI Ù…ÙˆØ¯Ø§Ù„ Ù…Ø§ Ù†Ø¨Ø§ÛŒØ¯ Ø±ÙˆÛŒ ØªØµÙˆÛŒØ± Ø¨ÛŒÙØªØ¯ */
    body.ios-fs #overlay{ background: transparent !important; }
    body.ios-fs .playerModal{
      background: transparent !important;
      border: 0 !important;
      box-shadow: none !important;
      padding: 0 !important;
    }
    body.ios-fs .playerHead,
    body.ios-fs .progressRow,
    body.ios-fs #motivateLine,
    body.ios-fs .playerModal > .hint{
      display: none !important;
    }

  
    /* ===== iOS WebView readability fixes (Android untouched) ===== */
    @supports (-webkit-touch-callout: none) {
      /* Telegram iOS sometimes resolves button text color too close to bg */
      .btnPrimary{
        color: #ffffff !important;
        text-shadow: 0 1px 0 rgba(0,0,0,.18);
      }
      /* Ensure ghost buttons are readable too */
      .btnGhost, .likeBtn, .closeBtn{
        color: var(--text) !important;
      }
    }


    @supports (-webkit-touch-callout: none) {
      body.tg .btnPrimary{
        background: var(--tg-theme-button-color, var(--primary)) !important;
      }
    }



    @supports (-webkit-touch-callout: none){
      /* iOS WebView: ensure overlay fully hides background behind player */
      .overlay{ background: rgba(0,0,0,.92) !important; }
      .playerModal{ background: #ffffff !important; }
      @media (prefers-color-scheme: dark){
        .playerModal{ background: #0b1220 !important; }
      }
    }

/* === User Gate === */
.ug-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:999999}
.ug-card{background:#fff;width:min(420px,92%);border-radius:18px;padding:18px;direction:rtl}
.ug-title{font-size:18px;font-weight:800;margin-bottom:6px}
.ug-sub{font-size:13px;opacity:.7;margin-bottom:12px}
.ug-card input{width:100%;height:44px;margin-bottom:10px;border-radius:12px;border:1px solid #ccc;padding:0 12px}
.ug-card button{width:100%;height:46px;border:none;border-radius:14px;background:#1976d2;color:#fff;font-weight:800}
.ug-error{color:#c62828;font-size:13px;margin-bottom:8px}
.ug-hidden{display:none!important}


/* iOS input zoom fix */
input, select, textarea { font-size: 16px !important; }
html { -webkit-text-size-adjust: 100%; }

</style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <!-- âœ… Ù‡Ø¯Ø± Ø¬Ø¯ÛŒØ¯ Ø·Ø¨Ù‚ Ø®ÙˆØ§Ø³ØªÙ‡ Ø´Ù…Ø§ -->
      <div class="brand">
        <!-- Ø³Ù…Øª Ø±Ø§Ø³Øª: Ù…ØªÙ† (ØªÙ…Ø§Ù… Ø¹Ø±Ø¶) -->
        <div class="brandText">
          <h1 class="title">Ø¢Ú©Ø§Ø¯Ù…ÛŒ Ø³ÛŒÙ„Ø§Ù†Ù‡ Ø³Ø¨Ø²</h1>
          <div class="subtitle" id="tagline">ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ Ù…Ø³ØªÙ…Ø±ØŒ Ù…Ø²ÛŒØª Ø±Ù‚Ø§Ø¨ØªÛŒ Ù…Ø§</div>
        </div>

        <!-- Ø³Ù…Øª Ú†Ù¾: Ù„ÙˆÚ¯Ùˆ + (Ø§Ø®ØªÛŒØ§Ø±ÛŒ) Ø¯Ú©Ù…Ù‡ ØªØºÛŒÛŒØ± Ø¯Ø³ØªÙ‡ -->
        <div class="brandActions">
          <button id="btnChangeCategory" class="btnGhost hidden">ØªØºÛŒÛŒØ± Ø¯Ø³ØªÙ‡</button>

          <!-- Ù„ÙˆÚ¯Ùˆ Ø§Ø² ÙØ§ÛŒÙ„ Ø±ÛŒÙ¾Ùˆ (logo-light.png) -->
          <div class="logo" title="Ù„ÙˆÚ¯Ùˆ">
            <img id="logoImg" src="logo-light.png" alt="Logo" />
          </div>
        </div>
      </div>

      <div id="controlsBlock" class="hidden">
        <div class="controls">
          <input id="q" class="search" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ø¢Ù…ÙˆØ²Ø´â€ŒÙ‡Ø§ (Ù…Ø«Ù„Ø§Ù‹: ÙØ±ÙˆØ´ØŒ Ù…Ø­ØµÙˆÙ„ØŒ ...)" />
</div>

        <div class="toolbar">
<select id="sortSel" class="select" aria-label="Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ">
            <option value="smart">Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯ (Ù¾ÛŒØ´â€ŒÙØ±Ø¶)</option>
            <option value="newest">Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† Ù…Ø­ØªÙˆØ§</option>
            <option value="liked">Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ù„Ø§ÛŒÚ©</option>
            <option value="engaging">Ø¬Ø°Ø§Ø¨â€ŒØªØ±ÛŒÙ† Ù…Ø­ØªÙˆØ§</option>
          </select>
        </div>
      </div>
    </div>

    <div id="categoryGate">
      <div style="display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin-top:12px;">
        <div class="pill" style="border-radius:999px;">
          Ù¾ÛŒØ´Ø±ÙØª Ø´Ù…Ø§:
          <span id="overallProgress" style="font-weight:900; margin-right:6px;">0%</span>
        </div>

        <button id="btnContinue" class="btnGhost" style="border-radius:999px;" disabled>
          Ø§Ø¯Ø§Ù…Ù‡:
          <span id="continueTitle" style="font-weight:900; margin-right:6px;">â€”</span>
        </button>

        <div id="continueHint" class="hint" style="margin:0; flex-basis:100%; display:none;"></div>
      </div>

      <!-- Admin Upload Panel (ONLY ADMINS SEE THIS) -->
      <div id="adminUpload" class="card hidden" style="margin-top:12px;">
        <div class="itemTitle" style="margin-bottom:8px;">Ø¢Ù¾Ù„ÙˆØ¯ Ù…Ø­ØªÙˆØ§ (Ø§Ø¯Ù…ÛŒÙ†)</div>

        <div class="formGrid">
          <input id="upTitle" class="inp" placeholder="Ø¹Ù†ÙˆØ§Ù† Ù…Ø­ØªÙˆØ§" />
          <select id="upCategory" class="select" style="min-width:auto;">
            <option value="sales">Ø¢Ù…ÙˆØ²Ø´ ÙØ±ÙˆØ´</option>
            <option value="product">Ø¢Ù…ÙˆØ²Ø´ Ù…Ø­ØµÙˆÙ„</option>
            <option value="mindset">Ù†Ú¯Ø±Ø´ÛŒ</option>
            <option value="campaign">Ø¢Ù…ÙˆØ²Ø´ Ú©Ù…Ù¾ÛŒÙ†</option>
            <option value="book">Ø®Ù„Ø§ØµÙ‡ Ú©ØªØ§Ø¨</option>
          </select>

          <input id="upFile" type="file" class="inp" />
          <input id="upDurationManual" class="inp hidden" placeholder="Ù…Ø¯Øª Ø²Ù…Ø§Ù† (Ø«Ø§Ù†ÛŒÙ‡) - Ø¯Ø³ØªÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†" inputmode="numeric" />
        </div>

        <div class="hint" id="upHint" style="margin-top:10px;">
          ÙØ§ÛŒÙ„ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†Ø› Ø³ÛŒØ³ØªÙ… Ù…Ø¯Øª Ø±Ø§ Ø®ÙˆØ¯Ú©Ø§Ø± Ø¯Ø±Ù…ÛŒâ€ŒØ¢ÙˆØ±Ø¯. Ø§Ú¯Ø± Ù†Ø´Ø¯ØŒ ÙÛŒÙ„Ø¯ Ø¯Ø³ØªÛŒ ÙØ¹Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
        </div>

        <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:12px;">
          <button id="btnUpload" class="btnPrimary">Ø¢Ù¾Ù„ÙˆØ¯ Ùˆ Ø«Ø¨Øª</button>
        </div>

        <div class="hint" id="upStatus" style="margin-top:10px; display:none;"></div>
      </div>

      <div class="catGrid" id="catGrid"></div>
    </div>

    <div id="listArea" class="hidden">
      <div id="list" class="grid"></div>
    </div>
  </div>

  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="playerModal">
      <div class="playerHead">
        <div>
          <h3 id="nowTitle" class="playerTitle"></h3>
          <div class="meta" style="margin-top:8px;">
<span class="tag" id="nowDuration">â€”</span>
            <span class="tag" id="nowLikes">â™¡ 0</span>
          </div>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <button id="btnFullscreen" class="closeBtn hidden" style="border-radius:14px;">ØªÙ…Ø§Ù… ØµÙØ­Ù‡</button>
          <button id="btnClose" class="closeBtn">Ø¨Ø³ØªÙ†</button>
        </div>
      </div>

      <div id="playerArea"></div>

      <div class="progressRow" style="margin-top: 14px;">
        <div class="bar"><div id="nowBar"></div></div>
        <div class="percent" id="nowPercent">0%</div>
      </div>

      <div class="motivate" id="motivateLine">Ø§Ú¯Ø± ØªØ§ Ø¢Ø®Ø± Ø¨Ø±ÛŒØŒ ÙØ±Ø¯Ø§ Ø±Ø§Ø­Øªâ€ŒØªØ±ÛŒ.</div>
      <div class="hint">Ù¾ÛŒØ´Ø±ÙØª Ø´Ù…Ø§ Ø®ÙˆØ¯Ú©Ø§Ø± Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
    </div>
  </div>

<script>
/* =========================
   CONFIG (Supabase)
========================= */
const SUPABASE_URL = "https://szjwrqzgiekjaggqsuoh.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_hkKIc6r7pSDCJsUvoOafrg_vK8xQc0F";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* =========================
   Telegram
========================= */
const tg = window.Telegram?.WebApp;

function resolveUserId() {
  try {
    if (tg) {
      tg.ready();
      const id = tg.initDataUnsafe?.user?.id;
      if (id) return String(id);
    }
  } catch (e) {}

  const qs = new URLSearchParams(location.search);
  const qid = qs.get("uid");
  if (qid) return String(qid);

  const saved = localStorage.getItem("dev_uid");
  if (saved) return saved;

  return "web_preview";
}
const TELEGRAM_ID = resolveUserId();

// iOS detection (including iPadOS masquerading as Mac)
const IS_IOS = (() => {
  const ua = navigator.userAgent || "";
  const iOS = /iPad|iPhone|iPod/.test(ua);
  const iPadOS13Plus = /Macintosh/.test(ua) && ("ontouchend" in document);
  return iOS || iPadOS13Plus;
})();


// =========================
// UA flags (iOS / Android WebView)
// =========================
const UA = navigator.userAgent || "";
const IS_ANDROID = /Android/i.test(UA);

if (IS_IOS) document.body.classList.add("ios");
if (IS_ANDROID) document.body.classList.add("android");

if (tg) {
  document.body.classList.add("tg");
  try { tg.expand(); } catch(e){}
}

/* =========================
   Helpers
========================= */
const $ = (id) => document.getElementById(id);

function showFatal(message){
  try{
    let box = document.getElementById("fatalBox");
    if(!box){
      box = document.createElement("div");
      box.id = "fatalBox";
      box.style.cssText = "position:fixed;left:12px;right:12px;bottom:12px;z-index:99999;background:rgba(220,38,38,.92);color:#fff;padding:12px 14px;border-radius:14px;font-weight:900;line-height:1.6;direction:rtl";
      document.body.appendChild(box);
    }
    box.textContent = message;
  }catch(e){}
}

window.addEventListener("error", (e) => {
  showFatal("Ø®Ø·Ø§ÛŒ Ø§Ø¬Ø±Ø§: " + (e?.message || "Ù†Ø§Ù…Ø´Ø®Øµ"));
});
window.addEventListener("unhandledrejection", (e) => {
  const msg = (e?.reason?.message) ? e.reason.message : String(e?.reason || "Ù†Ø§Ù…Ø´Ø®Øµ");
  showFatal("Ø®Ø·Ø§ÛŒ Promise: " + msg);
});

function secondsToMin(sec) {
  sec = Math.max(0, Math.floor(sec || 0));
  const m = Math.floor(sec / 60);
  const s = sec % 60;
  return `${m}:${String(s).padStart(2,'0')}`;
}
function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }
function calcPercent(pos, duration){
  if (!duration || duration <= 0) return 0;
  return clamp((pos / duration) * 100, 0, 100);
}
function show(el){ if(!el) return; el.hidden = false; el.classList.remove("hidden"); el.style.display = ""; }
function hide(el){ if(!el) return; el.hidden = true; el.classList.add("hidden"); el.style.display = "none"; }

let categoryGateEl = null;
let categoryGateParent = null;
let categoryGateNextSibling = null;

function captureCategoryGate(){
  categoryGateEl = $("categoryGate");
  categoryGateParent = categoryGateEl ? categoryGateEl.parentNode : null;
  categoryGateNextSibling = categoryGateEl ? categoryGateEl.nextSibling : null;
}
function detachCategoryGate(){
  if(!categoryGateEl) captureCategoryGate();
  if(!categoryGateEl || !categoryGateEl.parentNode) return;
  categoryGateEl.parentNode.removeChild(categoryGateEl);
}
function attachCategoryGate(){
  if(!categoryGateEl) captureCategoryGate();
  if(!categoryGateEl || !categoryGateParent) return;
  if(categoryGateEl.parentNode) return;
  if(categoryGateNextSibling && categoryGateNextSibling.parentNode === categoryGateParent){
    categoryGateParent.insertBefore(categoryGateEl, categoryGateNextSibling);
  }else{
    categoryGateParent.appendChild(categoryGateEl);
  }
}

/* =========================
   Supabase REST (tables)
========================= */
async function sGet(path) {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${path}`, {
    headers: { "apikey": SUPABASE_ANON_KEY, "Authorization": `Bearer ${SUPABASE_ANON_KEY}` }
  });
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}
async function sPost(path, body, merge=false) {
  const headers = {
    "apikey": SUPABASE_ANON_KEY,
    "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
    "Content-Type": "application/json",
  };
  if (merge) headers["Prefer"] = "resolution=merge-duplicates";
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${path}`, {
    method: "POST",
    headers,
    body: JSON.stringify(body),
  });
  if (!res.ok) throw new Error(await res.text());
  return true;
}
async function sDelete(path) {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${path}`, {
    method: "DELETE",
    headers: { "apikey": SUPABASE_ANON_KEY, "Authorization": `Bearer ${SUPABASE_ANON_KEY}` }
  });
  if (!res.ok) throw new Error(await res.text());
  return true;
}

/* =========================
   Categories
========================= */
const CATEGORIES = [
  { key: "sales",  title: "Ø¢Ù…ÙˆØ²Ø´ ÙØ±ÙˆØ´",   desc: "Ù…Ù‡Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø°Ø§Ú©Ø±Ù‡ØŒ Ù¾ÛŒÚ¯ÛŒØ±ÛŒØŒ Ø¨Ø³ØªÙ† ÙØ±ÙˆØ´" },
  { key: "product",title: "Ø¢Ù…ÙˆØ²Ø´ Ù…Ø­ØµÙˆÙ„", desc: "Ø¯Ø§Ù†Ø´ Ù…Ø­ØµÙˆÙ„ØŒ Ù…Ø²Ø§ÛŒØ§ØŒ ØªÙØ§ÙˆØªâ€ŒÙ‡Ø§ Ùˆ Ú©Ø§Ø±Ø¨Ø±Ø¯Ù‡Ø§" },
  { key: "mindset",title: "Ù†Ú¯Ø±Ø´ÛŒ",       desc: "ØªÙÚ©Ø±ØŒ Ø§Ù†Ú¯ÛŒØ²Ù‡ØŒ Ù…Ø¯ÛŒØ±ÛŒØª Ø²Ù…Ø§Ù†ØŒ Ø±Ø´Ø¯ ÙØ±Ø¯ÛŒ" },
  { key: "campaign",title:"Ø¢Ù…ÙˆØ²Ø´ Ú©Ù…Ù¾ÛŒÙ†", desc: "Ú©Ù…Ù¾ÛŒÙ†â€ŒØ³Ø§Ø²ÛŒØŒ Ø§Ø¬Ø±Ø§ØŒ KPI Ùˆ ØªØ­Ù„ÛŒÙ„" },
  { key: "book",  title: "Ø®Ù„Ø§ØµÙ‡ Ú©ØªØ§Ø¨",  desc: "Ú†Ú©ÛŒØ¯Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ ØªØµÙ…ÛŒÙ…â€ŒÚ¯ÛŒØ±ÛŒ Ø¨Ù‡ØªØ±" },
];

function renderCategories(){
  const grid = $("catGrid");
  grid.innerHTML = "";
  CATEGORIES.forEach(c => {
    const div = document.createElement("div");
    div.className = "catCard";
    div.innerHTML = `<div class="catName">${c.title}</div><p class="catDesc">${c.desc}</p>`;
    div.onclick = () => selectCategory(c.key);
    grid.appendChild(div);
  });
}

/* =========================
   State
========================= */
let ALL_CONTENTS = [];
let CURRENT_CATEGORY = null;
let SORT_MODE = "smart";

let progressByContent = new Map();
let engagementByContent = new Map();
let likeCountByContent = new Map();
let likedByMe = new Set();

let continueItem = null;

/* =========================
   Progress / Likes loaders
========================= */
async function loadMyProgress(){
  const rows = await sGet(`progress?select=content_id,last_position_seconds,completion_percent,updated_at,duration_seconds&telegram_id=eq.${encodeURIComponent(TELEGRAM_ID)}&limit=5000`);
  progressByContent = new Map();
  rows.forEach(r => progressByContent.set(r.content_id, r));
}

async function loadEngagementAllUsers(contentIds){
  if (!contentIds.length) { engagementByContent = new Map(); return; }
  const inList = contentIds.join(",");
  const rows = await sGet(`progress?select=content_id,active_seconds&content_id=in.(${inList})&limit=10000`);
  engagementByContent = new Map();
  rows.forEach(r => {
    const prev = engagementByContent.get(r.content_id) || 0;
    engagementByContent.set(r.content_id, prev + (r.active_seconds || 0));
  });
}

async function loadLikesForContents(contentIds){
  if (!contentIds.length) {
    likeCountByContent = new Map();
    likedByMe = new Set();
    return;
  }
  const inList = contentIds.join(",");
  const rowsAll = await sGet(`likes?select=content_id&content_id=in.(${inList})&limit=10000`);
  likeCountByContent = new Map();
  rowsAll.forEach(r => likeCountByContent.set(r.content_id, (likeCountByContent.get(r.content_id) || 0) + 1));

  const rowsMe = await sGet(`likes?select=content_id&content_id=in.(${inList})&telegram_id=eq.${encodeURIComponent(TELEGRAM_ID)}&limit=5000`);
  likedByMe = new Set(rowsMe.map(r => r.content_id));
}

async function toggleLike(contentId){
  const isLiked = likedByMe.has(contentId);
  try{
    if (isLiked){
      await sDelete(`likes?telegram_id=eq.${encodeURIComponent(TELEGRAM_ID)}&content_id=eq.${contentId}`);
      likedByMe.delete(contentId);
      likeCountByContent.set(contentId, Math.max(0, (likeCountByContent.get(contentId)||1) - 1));
    } else {
      await sPost("likes", [{ telegram_id: TELEGRAM_ID, content_id: contentId, created_at: new Date().toISOString() }], false);
      likedByMe.add(contentId);
      likeCountByContent.set(contentId, (likeCountByContent.get(contentId)||0) + 1);
    }
  }catch(e){ console.error(e); }
}

/* =========================
   Continue watching
========================= */
async function loadContinueWatching(){
  const rows = await sGet(`progress?select=content_id,updated_at,last_position_seconds,completion_percent&telegram_id=eq.${encodeURIComponent(TELEGRAM_ID)}&order=updated_at.desc&limit=1`);
  const p = rows[0];
  if (!p) return null;
  const c = ALL_CONTENTS.find(x => x.id === p.content_id);
  if (!c) return null;
  return { content: c, progress: p };
}

function updateContinueUI(){
  if (!continueItem){
    $("continueTitle").textContent = "â€”";
    $("btnContinue").disabled = true;
    return;
  }
  const {content} = continueItem;
  $("continueTitle").textContent = content.title.length > 18 ? content.title.slice(0,18) + "â€¦" : content.title;
  $("btnContinue").disabled = false;
  $("btnContinue").onclick = () => openPlayer(content);
}

/* =========================
   Category selection
========================= */
function selectCategory(key){
  CURRENT_CATEGORY = key;
  try{ document.body.classList.add("in-cat"); }catch(e){}
  detachCategoryGate();
  show($("listArea"));
  show($("controlsBlock"));
  show($("btnChangeCategory"));

  
  // ÙÙ‚Ø· Ø¯Ø± ØµÙØ­Ù‡ Ù‡ÙˆÙ… Ù„ÙˆÚ¯Ùˆ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆØ¯
  try{ const _logo = document.querySelector(".logo"); if(_logo) _logo.classList.add("hidden"); }catch(e){}
applyFiltersAndRender();
  try{ window.__topbarOnScroll && window.__topbarOnScroll(); }catch(e){}
}

$("btnChangeCategory").onclick = () => {
  CURRENT_CATEGORY = null;
  try{ document.body.classList.remove("in-cat"); }catch(e){}
  hide($("listArea"));
  hide($("controlsBlock"));
  hide($("btnChangeCategory"));
  try{ const tb=document.querySelector(".topbar"); if(tb) tb.classList.remove("hideTopbar"); }catch(e){}
  try{ window.scrollTo(0,0); }catch(e){}

  
  // Ø¨Ø±Ú¯Ø´Øª Ø¨Ù‡ Ù‡ÙˆÙ…: Ù„ÙˆÚ¯Ùˆ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆØ¯
  try{ const _logo = document.querySelector(".logo"); if(_logo) _logo.classList.remove("hidden"); }catch(e){}
attachCategoryGate();
  show($("categoryGate"));
  renderCategories();

  $("q").value = "";
  $("sortSel").value = "smart";
  SORT_MODE = "smart";
};

/* =========================
   Filters
========================= */
$("q").addEventListener("input", () => applyFiltersAndRender());
$("sortSel").addEventListener("change", () => { SORT_MODE = $("sortSel").value; applyFiltersAndRender(); });


/* =========================
   Rendering list
========================= */
function contentTypeLabel(t){ return t === "audio" ? "Ù¾Ø§Ø¯Ú©Ø³Øª" : "ÙˆÛŒØ¯ÛŒÙˆ"; }

function getContentCategoryKey(c){
  const k = (c.category_key || "").trim();
  if (CATEGORIES.some(x => x.key === k)) return k;
  return "other";
}

function applyFiltersAndRender(){
  if (!CURRENT_CATEGORY) return;

  const q = ($("q").value || "").trim().toLowerCase();
  let items = ALL_CONTENTS.filter(c => getContentCategoryKey(c) === CURRENT_CATEGORY);

  if (!items.length){
    $("list").innerHTML = `<div class="card empty">Ø¯Ø± Ø§ÛŒÙ† Ø¯Ø³ØªÙ‡ Ù‡Ù†ÙˆØ² Ù…Ø­ØªÙˆØ§ÛŒÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡.</div>`;
    updateCategoryProgress();
    return;
  }
  if (q) items = items.filter(x => (x.title || "").toLowerCase().includes(q));

  items.sort((a,b) => compareItems(a,b));
  renderItems(items);
  updateCategoryProgress();
}

function compareItems(a,b){
  const pa = progressByContent.get(a.id);
  const pb = progressByContent.get(b.id);

  const pctA = Number(pa?.completion_percent || 0);
  const pctB = Number(pb?.completion_percent || 0);

  const incompleteA = pctA < 99.9;
  const incompleteB = pctB < 99.9;

  const likesA = likeCountByContent.get(a.id) || 0;
  const likesB = likeCountByContent.get(b.id) || 0;

  const engA = engagementByContent.get(a.id) || 0;
  const engB = engagementByContent.get(b.id) || 0;

  const createdA = a.created_at ? new Date(a.created_at).getTime() : a.id;
  const createdB = b.created_at ? new Date(b.created_at).getTime() : b.id;

  if (SORT_MODE === "newest") return createdB - createdA;
  if (SORT_MODE === "liked") return (likesB - likesA) || (createdB - createdA);
  if (SORT_MODE === "engaging") return (engB - engA) || (createdB - createdA);

  if (incompleteA !== incompleteB) return incompleteA ? -1 : 1;
  if (incompleteA && incompleteB) {
    if (pctA !== pctB) return pctB - pctA;
  }
  return createdB - createdA;
}

function renderItems(items){
  const list = $("list");
  list.innerHTML = "";

  items.forEach(item => {
    const p = progressByContent.get(item.id);
    const pct = Number(p?.completion_percent || 0);
    const duration = Number(item.duration_seconds || 0);

    const likeCount = likeCountByContent.get(item.id) || 0;
    const isLiked = likedByMe.has(item.id);

    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <div class="itemHead">
        <div style="flex:1; min-width:0;">
          <div class="itemTitle">${item.title}</div>
          <div class="meta">
            <span class="tag">Ù…Ø¯Øª ${secondsToMin(duration)}</span>
          </div>
        </div>

        <div style="display:flex; gap:10px; align-items:center;">
          <button class="likeBtn ${isLiked ? "liked" : ""}" data-like="${item.id}" title="Ù„Ø§ÛŒÚ©">
            ${isLiked ? "â™¥" : "â™¡"} <span>${likeCount}</span>
          </button>
          <button class="btnPrimary" data-play="${item.id}">Ù¾Ø®Ø´</button>
        </div>
      </div>

      <div class="progressRow">
        <div class="bar"><div style="width:${pct}%;"></div></div>
        <div class="percent">${pct.toFixed(0)}%</div>
      </div>
    `;

    card.querySelector(`[data-play="${item.id}"]`).onclick = () => openPlayer(item);
    card.querySelector(`[data-like="${item.id}"]`).onclick = async () => {
      await toggleLike(item.id);
      applyFiltersAndRender();
      if (currentPlayerContent && currentPlayerContent.id === item.id){
        $("nowLikes").textContent = `â™¡ ${likeCountByContent.get(item.id) || 0}`;
      }
    };

    list.appendChild(card);
  });
}

/* =========================
   Progress summaries
========================= */
function updateCategoryProgress(){
  
  const _cp = $("catProgress");
  const _cph = $("catProgressHint");
  if (!_cp || !_cph) return; // UI Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø­Ø°Ù Ø´Ø¯Ù‡
const allInCat = ALL_CONTENTS.filter(c => getContentCategoryKey(c) === CURRENT_CATEGORY);
  if (!allInCat.length){
    $("catProgress").textContent = "0%";
    $("catProgressHint").textContent = "â€”";
    return;
  }
  let sum = 0;
  allInCat.forEach(c => sum += Number(progressByContent.get(c.id)?.completion_percent || 0));
  const avg = sum / allInCat.length;
  $("catProgress").textContent = `${avg.toFixed(0)}%`;
  $("catProgressHint").textContent = `${allInCat.length} Ø¢Ù…ÙˆØ²Ø´ Ø¯Ø± Ø§ÛŒÙ† Ø¯Ø³ØªÙ‡`;
}

function updateOverallProgress(){
  if (!ALL_CONTENTS.length){
    $("overallProgress").textContent = "0%";
    return;
  }
  let sum = 0;
  ALL_CONTENTS.forEach(c => sum += Number(progressByContent.get(c.id)?.completion_percent || 0));
  const avg = sum / ALL_CONTENTS.length;
  $("overallProgress").textContent = `${avg.toFixed(0)}%`;
}

/* =========================
   Player
========================= */
let currentPlayerContent = null;

$("btnClose").onclick = closePlayer;
$("btnFullscreen").onclick = async () => {
  const v = $("playerArea").querySelector("video");
  if (!v) return;

  // 1) Telegram WebApp native fullscreen (Ø§Ú¯Ø± Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ú©Ù†Ø¯) â€” Ù…Ø®ØµÙˆØµØ§Ù‹ Ø¨Ø±Ø§ÛŒ Ø§Ù†Ø¯Ø±ÙˆÛŒØ¯ Ù…ÙÛŒØ¯ Ø§Ø³Øª
  try{
    if (tg && typeof tg.requestFullscreen === "function") {
      tg.requestFullscreen();
    }
  }catch(e){}

  // 2) Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ù…Ø±ÙˆØ±Ú¯Ø±
  try{
    if (v.requestFullscreen) {
      await v.requestFullscreen();
      return;
    }
  }catch(e){}

  // 3) WebKit/iOS fallback
  try{
    if (v.webkitEnterFullscreen) { v.webkitEnterFullscreen(); return; }
    if (v.webkitRequestFullscreen) { v.webkitRequestFullscreen(); return; }
  }catch(e){}
};
$("overlay").addEventListener("click", (e) => {
  if (e.target === $("overlay")) closePlayer();
});

function setMotivationLine(pct){
  const p = Math.floor(pct);
  if (p >= 95) return "ÙÙ‚Ø· Ú†Ù†Ø¯ Ø«Ø§Ù†ÛŒÙ‡ ØªØ§ Ù¾Ø§ÛŒØ§Ù†! Ø¹Ø§Ù„ÛŒÙ‡ ğŸ‘Œ";
  if (p >= 70) return "ØªÙ‚Ø±ÛŒØ¨Ø§Ù‹ ØªÙ…ÙˆÙ…Ø´ Ú©Ø±Ø¯ÛŒ. Ù‡Ù…ÛŒÙ† ÛŒÚ©â€ŒØ°Ø±Ù‡ Ø±Ùˆ Ø¨Ø¨Ù†Ø¯.";
  if (p >= 30) return "Ø®ÙˆØ¨Ù‡. Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø¯Ù‡ ØªØ§ Ù†Ú©ØªÙ‡â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ Ø¬Ù…Ø¹ Ø¨Ø´Ù‡.";
  return "Ø´Ø±ÙˆØ¹ Ø¹Ø§Ù„ÛŒÙ‡. ÙÙ‚Ø· Û² Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¯ÛŒÚ¯Ù‡ Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø¯Ù‡.";
}

async function openPlayer(content){
  currentPlayerContent = content;

  $("nowTitle").textContent = content.title;
$("nowDuration").textContent = `Ù…Ø¯Øª ${secondsToMin(content.duration_seconds || 0)}`;

  const likes = likeCountByContent.get(content.id) || 0;
  $("nowLikes").textContent = `â™¡ ${likes}`;

  const area = $("playerArea");
  area.innerHTML = "";

  const isVideo = content.type === "video";
  if (isVideo) show($("btnFullscreen")); else hide($("btnFullscreen"));

  const media = document.createElement(isVideo ? "video" : "audio");
  media.controls = true;
  media.src = content.file_path;

  media.setAttribute("controlsList", "nodownload noplaybackrate");
  media.setAttribute("disablePictureInPicture", "true");
  media.oncontextmenu = () => false;
  if (isVideo) {
    // iOS: playsInline=true Ø¨Ø§Ø¹Ø« Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ Ø¨Ù‡ØªØ± Ú©Ø§Ø± Ú©Ù†Ù†Ø¯ Ùˆ Ù‡Ù†Ú¯Ø§Ù… fullscreen nativeØŒ Ø¨Ø§Ú¯â€ŒÙ‡Ø§ÛŒ overlay Ú©Ù…ØªØ± Ø´ÙˆØ¯
    media.playsInline = IS_IOS ? true : false;
  }

  area.appendChild(media);

  // iOS native fullscreen events (prevent overlay UI from stacking on top)
  if (isVideo && IS_IOS) {
    const enter = () => document.body.classList.add("ios-fs");
    const exit  = () => document.body.classList.remove("ios-fs");
    media.addEventListener("webkitbeginfullscreen", enter);
    media.addEventListener("webkitendfullscreen", exit);
  }

  $("overlay").classList.add("show");
  $("overlay").setAttribute("aria-hidden", "false");

  
  document.body.classList.add("modal-open");
const p = progressByContent.get(content.id);
  const lastPos = Number(p?.last_position_seconds || 0);
  const duration = Number(content.duration_seconds || 0);

  function updateUI(currentTime){
    const pos = Math.floor(currentTime || 0);
    const pct = calcPercent(pos, duration);
    $("nowPercent").textContent = `${pct.toFixed(0)}%`;
    $("nowBar").style.width = `${pct}%`;
    $("motivateLine").textContent = setMotivationLine(pct);
  }

  media.addEventListener("loadedmetadata", () => {
    if (lastPos > 0 && lastPos < (media.duration || 999999)) {
      media.currentTime = lastPos;
    }
    updateUI(media.currentTime);
  });

  let lastSentAt = 0;

  async function saveNow(force=false){
    const pos = Math.floor(media.currentTime || 0);
    const pct = calcPercent(pos, duration);
    updateUI(media.currentTime);

    try{
      await sPost("progress", [{
        telegram_id: TELEGRAM_ID,
        content_id: content.id,
        last_position_seconds: pos,
        max_position_seconds: pos,
        duration_seconds: duration || 0,
        completion_percent: Number(pct.toFixed(2)),
        active_seconds: pos,
        updated_at: new Date().toISOString()
      }], true);

      try{
        await sPost("listen_events", [{
          telegram_id: TELEGRAM_ID,
          content_id: content.id,
          event_time: new Date().toISOString(),
          position_seconds: pos,
          event_type: force ? "pause_or_end" : "progress"
        }], false);
      }catch(e){ console.error(e); }

      progressByContent.set(content.id, {
        content_id: content.id,
        last_position_seconds: pos,
        completion_percent: Number(pct.toFixed(2)),
        updated_at: new Date().toISOString(),
        duration_seconds: duration || 0
      });
      updateOverallProgress();
    }catch(e){ console.error(e); }
  }

  media.addEventListener("timeupdate", () => {
    updateUI(media.currentTime);
    if (Math.abs(media.currentTime - lastSentAt) >= 10) {
      lastSentAt = media.currentTime;
      saveNow(false);
    }
  });

  media.addEventListener("pause", () => saveNow(true));
  media.addEventListener("ended", () => {
    media.currentTime = duration || media.duration || 0;
    saveNow(true);
  });

  updateUI(lastPos);
}

function closePlayer(){
  try{ hide($("btnFullscreen")); }catch(e){}
  $("overlay").classList.remove("show");
  $("overlay").setAttribute("aria-hidden", "true");
    document.body.classList.remove("modal-open");
  document.body.classList.remove("ios-fs");
currentPlayerContent = null;
  if (CURRENT_CATEGORY) applyFiltersAndRender();
}

/* =========================
   Admin Upload
========================= */
const ADMIN_IDS = new Set(["193158792","6545251601"]);
function isAdmin(){
  if (!tg) return false;
  return ADMIN_IDS.has(String(TELEGRAM_ID));
}
function showUploadStatus(msg, isError=false){
  const el = $("upStatus");
  el.style.display = "block";
  el.style.color = isError ? "rgba(220,38,38,.95)" : "rgba(22,163,74,.95)";
  el.textContent = msg;
}
function sanitizeFileName(name){
  const ext = (name.split(".").pop() || "").toLowerCase();
  const base = name.replace(/\.[^/.]+$/, "");
  const safeBase = base
    .normalize("NFKD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-zA-Z0-9_-]+/g, "_")
    .replace(/_+/g, "_")
    .replace(/^_+|_+$/g, "")
    .slice(0, 80);
  return `${safeBase || "file"}_${Date.now()}.${ext || "bin"}`;
}
function getDurationFromFile(file){
  return new Promise((resolve) => {
    if (!file) return resolve(null);
    const url = URL.createObjectURL(file);
    const isVideo = file.type.startsWith("video/");
    const el = document.createElement(isVideo ? "video" : "audio");
    let settled = false;
    const cleanup = (val) => {
      if (settled) return;
      settled = true;
      try { URL.revokeObjectURL(url); } catch(e){}
      resolve(val);
    };
    el.preload = "metadata";
    el.src = url;
    el.onloadedmetadata = () => {
      const d = Number(el.duration);
      if (Number.isFinite(d) && d > 0) cleanup(Math.floor(d));
      else cleanup(null);
    };
    el.onerror = () => cleanup(null);
    setTimeout(() => cleanup(null), 2500);
  });
}
function detectType(file){
  if (!file) return "audio";
  if (file.type.startsWith("video/")) return "video";
  if (file.type.startsWith("audio/")) return "audio";
  const name = (file.name || "").toLowerCase();
  if (name.endsWith(".mp4") || name.endsWith(".mov") || name.endsWith(".mkv")) return "video";
  return "audio";
}
async function uploadToStorage(file){
  const safeName = sanitizeFileName(file.name || "file.bin");
  const path = `uploads/${safeName}`;
  const { data, error } = await supabase
    .storage
    .from("training-media")
    .upload(path, file, {
      upsert: true,
      contentType: file.type || "application/octet-stream",
      cacheControl: "3600"
    });
  if (error) throw new Error("Storage upload failed: " + error.message);
  const { data: pub } = supabase.storage.from("training-media").getPublicUrl(data.path);
  return { path: data.path, publicUrl: pub.publicUrl };
}
async function insertContentRow({title, type, category_key, file_url, duration_seconds}){
  await sPost("contents", [{
    title,
    type,
    category_key,
    file_path: file_url,
    duration_seconds: Number(duration_seconds) || 0,
    created_at: new Date().toISOString()
  }], false);
}
function initAdminUpload(){
  const panel = $("adminUpload");
  if (!panel) return;
  if (isAdmin()) show(panel); else hide(panel);

  // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø«Ø¨Øª Ú†Ù†Ø¯Ø¨Ø§Ø±Ù‡Ù” Ù„ÛŒØ³Ù†Ø±Ù‡Ø§ (Ø¹Ù„Øª Ø¢Ù¾Ù„ÙˆØ¯ Ú†Ù†Ø¯Ø¨Ø§Ø±Ù‡)
  if (panel.dataset.bound === "1") return;
  panel.dataset.bound = "1";

  $("upFile")?.addEventListener("change", async () => {
    const file = $("upFile").files?.[0];
    $("upDurationManual").classList.add("hidden");
    $("upDurationManual").value = "";
    $("upDurationManual").dataset.auto = "";
    if (!file) return;

    $("upHint").textContent = "Ø¯Ø± Ø­Ø§Ù„ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¯Øª Ø²Ù…Ø§Ù† Ø§Ø² ÙØ§ÛŒÙ„...";
    const dur = await getDurationFromFile(file);

    if (dur && dur > 0){
      $("upHint").textContent = `Ù…Ø¯Øª Ø²Ù…Ø§Ù† Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯: ${dur} Ø«Ø§Ù†ÛŒÙ‡`;
      $("upDurationManual").classList.add("hidden");
      $("upDurationManual").dataset.auto = String(dur);
    } else {
      $("upHint").textContent = "Ù…Ø¯Øª Ø²Ù…Ø§Ù† Ø§Ø² ÙØ§ÛŒÙ„ Ù‚Ø§Ø¨Ù„ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù†Ø¨ÙˆØ¯. Ù„Ø·ÙØ§Ù‹ Ù…Ø¯Øª Ø±Ø§ Ø¯Ø³ØªÛŒ (Ø«Ø§Ù†ÛŒÙ‡) ÙˆØ§Ø±Ø¯ Ú©Ù†.";
      $("upDurationManual").classList.remove("hidden");
    }
  }, { passive: true });

  $("btnUpload")?.addEventListener("click", async () => {
    // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ø¬Ø±Ø§ÛŒ Ú†Ù†Ø¯Ø¨Ø§Ø±Ù‡ (Ø¯ÙˆØ¨Ø§Ø±Ú©Ù„ÛŒÚ© ÛŒØ§ Ú†Ù†Ø¯ Ù„ÛŒØ³Ù†Ø±)
    if (window.__upload_inflight) return;
    window.__upload_inflight = true;
    const __btn = $("btnUpload");
    if (__btn) __btn.disabled = true;
    try{
      const title = ($("upTitle").value || "").trim();
      const category_key = $("upCategory").value;
      const file = $("upFile").files?.[0];

      if (!title) return showUploadStatus("Ø¹Ù†ÙˆØ§Ù† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†.", true);
      if (!file) return showUploadStatus("ÙØ§ÛŒÙ„ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†.", true);

      let duration_seconds = Number($("upDurationManual").dataset.auto || 0);
      if (!duration_seconds || duration_seconds <= 0){
        const manual = Number(($("upDurationManual").value || "").trim());
        if (!manual || manual <= 0) return showUploadStatus("Ù…Ø¯Øª Ø²Ù…Ø§Ù† Ù…Ø´Ø®Øµ Ù†ÛŒØ³Øª. Ø¹Ø¯Ø¯ Ø«Ø§Ù†ÛŒÙ‡ Ø±Ø§ Ø¯Ø³ØªÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†.", true);
        duration_seconds = Math.floor(manual);
      }

      const type = detectType(file);

      showUploadStatus("Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ø¨Ù‡ Storage...");
      const { publicUrl } = await uploadToStorage(file);

      showUploadStatus("Ø¢Ù¾Ù„ÙˆØ¯ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯. Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øª Ø¯Ø± Ø¬Ø¯ÙˆÙ„ contents...");
      await insertContentRow({ title, type, category_key, file_url: publicUrl, duration_seconds });

      showUploadStatus("âœ… Ø«Ø¨Øª Ø´Ø¯. Ø¯Ø± Ø­Ø§Ù„ Ø±ÛŒÙØ±Ø´ Ù„ÛŒØ³Øª...");
      try{ renderCategories(); }catch(e){}
    await await ensureUserOnce();
      refreshAll();
    try{ setupTopbarAutoHide(); }catch(e){}

    $("upTitle").value = "";
      $("upFile").value = "";
      $("upDurationManual").value = "";
      $("upDurationManual").dataset.auto = "";
      $("upDurationManual").classList.add("hidden");
      $("upHint").textContent = "ÙØ§ÛŒÙ„ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†Ø› Ø³ÛŒØ³ØªÙ… Ù…Ø¯Øª Ø±Ø§ Ø®ÙˆØ¯Ú©Ø§Ø± Ø¯Ø±Ù…ÛŒâ€ŒØ¢ÙˆØ±Ø¯. Ø§Ú¯Ø± Ù†Ø´Ø¯ØŒ ÙÛŒÙ„Ø¯ Ø¯Ø³ØªÛŒ ÙØ¹Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯.";
    }catch(e){
      console.error("UPLOAD/INSERT ERROR:", e);
      const msg = (e?.message ? e.message : String(e));
      showUploadStatus("âŒ Ø®Ø·Ø§ÛŒ ÙˆØ§Ù‚Ø¹ÛŒ: " + msg, true);
    }
    finally {
      window.__upload_inflight = false;
      const __btn2 = $("btnUpload");
      if (__btn2) __btn2.disabled = false;
    }
  });
}

/* =========================
   Refresh All
========================= */
async function refreshAll(){
  ALL_CONTENTS = await sGet("contents?select=id,title,type,duration_seconds,file_path,category_key,created_at&order=id.desc&limit=5000");
  await loadMyProgress();
  continueItem = await loadContinueWatching();
  updateContinueUI();
  updateOverallProgress();
  try{ renderCategories(); }catch(e){ console.error(e); }
  try{ initAdminUpload(); }catch(e){ console.error(e); }
}


function setupTopbarAutoHide(){
  const tb = document.querySelector(".topbar");
  if(!tb) return;
  const threshold = 120; // ÙˆÙ‚ØªÛŒ Ø§Ø² Ù‡Ø¯Ø± Ø±Ø¯ Ø´Ø¯ÛŒÙ…
  let hideTimer = null;

  const applyHiddenState = (shouldHide) => {
    if(shouldHide){
      tb.classList.add("hideTopbar");
      // Ø¨Ø¹Ø¯ Ø§Ø² Ø§Ù†ÛŒÙ…ÛŒØ´Ù†ØŒ Ú©Ø§Ù…Ù„ Ø§Ø² DOM flow Ø®Ø§Ø±Ø¬Ø´ Ú©Ù† ØªØ§ "Ú©Ù…Ø±Ù†Ú¯ ÙˆÙ„ÛŒ Ù‡Ø³Øª" Ù†Ø´Ù‡
      if(hideTimer) clearTimeout(hideTimer);
      hideTimer = setTimeout(() => {
        // Ø§Ú¯Ø± Ù‡Ù†ÙˆØ² Ø¨Ø§ÛŒØ¯ Ù…Ø®ÙÛŒ Ø¨Ø§Ø´Ø¯
        if(CURRENT_CATEGORY && (window.scrollY || document.documentElement.scrollTop || 0) > threshold){
          tb.classList.add("goneTopbar");
        }
      }, 220);
    } else {
      if(hideTimer) clearTimeout(hideTimer);
      tb.classList.remove("goneTopbar");
      tb.classList.remove("hideTopbar");
    }
  };

  const onScroll = () => {
    const y = (window.scrollY || document.documentElement.scrollTop || 0);
    const shouldHide = !!CURRENT_CATEGORY && y > threshold;
    applyHiddenState(shouldHide);
  };

  window.addEventListener("scroll", onScroll, {passive:true});
  window.__topbarOnScroll = onScroll;
  onScroll();
}

/* =========================
   Boot
========================= */
(async () => {
  try{
    await refreshAll();

    const _selectCategory = selectCategory;
    selectCategory = async (key) => {
      CURRENT_CATEGORY = key;

      const ids = ALL_CONTENTS
        .filter(c => getContentCategoryKey(c) === key)
        .map(c => c.id);

      try{ await loadLikesForContents(ids); } catch(e){ console.error(e); }
      try{ await loadEngagementAllUsers(ids); } catch(e){ console.error(e); }

      _selectCategory(key);
    };
  }catch(e){
    console.error(e);
    try{ renderCategories(); }catch(_e){}
    const g = $("catGrid");
    if (g){
      g.innerHTML = `<div class="card empty">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ. Ø§ØªØµØ§Ù„ Supabase/Ø§ÛŒÙ†ØªØ±Ù†Øª Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯. Ø§Ú¯Ø± Ù‡ÛŒÚ† ØªØºÛŒÛŒØ±ÛŒ Ù†Ù…ÛŒâ€ŒØ¨ÛŒÙ†ÛŒØŒ Ù„ÛŒÙ†Ú© Ù…Ù†ÙˆØ¨ÙˆØªÙ† Ø±Ø§ Ø¨Ø§ ?v=123 Ø¹ÙˆØ¶ Ú©Ù† ØªØ§ Ú©Ø´ ØªÙ„Ú¯Ø±Ø§Ù… Ø¨Ø´Ú©Ù†Ø¯.</div>`;
    } else {
      showFatal("Ø®Ø·Ø§: catGrid Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯");
    }
  }
})();


// ====== USER GATE (safe patch) ======
async function ensureUserOnce(){
  try{
    const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user;
    if(!tgUser || !tgUser.id){
      // If opened outside Telegram, don't block app; show a message if desired.
      return;
    }
    const telegram_id = String(tgUser.id);

    // Fetch the profile fields
    const { data: existing, error: selErr } = await supabase
      .from('users')
      .select('full_name, mobile, job_title')
      .eq('telegram_id', telegram_id)
      .maybeSingle();

    if(selErr){
      // If we can't read, don't brick the app; just continue
      console.warn('users select error', selErr);
      return;
    }

    const isComplete = existing &&
      (existing.full_name||'').trim() &&
      (existing.mobile||'').trim() &&
      (existing.job_title||'').trim();

    if(isComplete) return;

    const gate = document.getElementById('userGate');
    const ugError = document.getElementById('ugError');
    const ugFullName = document.getElementById('ugFullName');
    const ugMobile = document.getElementById('ugMobile');
    const ugJobTitle = document.getElementById('ugJobTitle');
    const ugSubmit = document.getElementById('ugSubmit');

    gate.classList.remove('ug-hidden');

    await new Promise(resolve=>{
      ugSubmit.onclick = async ()=>{
        const full_name = (ugFullName.value||'').trim();
        const mobile = (ugMobile.value||'').trim();
        const job_title = (ugJobTitle.value||'').trim();

        if(!full_name || !/^09\d{9}$/.test(mobile) || !job_title){
          ugError.textContent = 'Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ùˆ Ø¯Ø±Ø³Øª Ù¾Ø± Ú©Ù†';
          ugError.classList.remove('ug-hidden');
          return;
        }

        const { error: upErr } = await supabase
          .from('users')
          .upsert({ telegram_id, full_name, mobile, job_title }, { onConflict: 'telegram_id' });

        if(upErr){
          ugError.textContent = 'Ø«Ø¨Øª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯. Ø¯Ø³ØªØ±Ø³ÛŒ Supabase/Ø§ÛŒÙ†ØªØ±Ù†Øª Ø±Ø§ Ú†Ú© Ú©Ù†.';
          ugError.classList.remove('ug-hidden');
          console.error('users upsert error', upErr);
          return;
        }

        gate.classList.add('ug-hidden');
        resolve();
      };
    });
  }catch(e){
    console.error('ensureUserOnce fatal', e);
  }
}

</script>

<!-- ====== USER FIRST-TIME GATE ====== -->
<div id="userGate" class="ug-backdrop ug-hidden">
  <div class="ug-card">
    <div class="ug-title">Ù‚Ø¨Ù„ Ø§Ø² Ø´Ø±ÙˆØ¹</div>
    <div class="ug-sub">Ù„Ø·ÙØ§Ù‹ Ø§Ø·Ù„Ø§Ø¹Ø§ØªØª Ø±Ùˆ ÙÙ‚Ø· ÛŒÚ©â€ŒØ¨Ø§Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†</div>

    <input id="ugFullName" placeholder="Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ" />
    <input id="ugMobile" placeholder="Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ (09xxxxxxxxx)" inputmode="numeric" />
    <input id="ugJobTitle" placeholder="Ù¾ÙˆØ²ÛŒØ´Ù† (Ù…Ø«Ù„Ø§Ù‹: Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨)" />

    <div id="ugError" class="ug-error ug-hidden"></div>
    <button id="ugSubmit">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø¢Ú©Ø§Ø¯Ù…ÛŒ</button>
  </div>
</div>

</body>
</html>
