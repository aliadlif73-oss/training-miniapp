<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø¢Ú©Ø§Ø¯Ù…ÛŒ Ø³ÛŒÙ„Ø§Ù†Ù‡ Ø³Ø¨Ø²</title>

  
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1220;
      --card:#0f172a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border: rgba(229,231,235,.10);
      --shadow: 0 10px 26px rgba(0,0,0,.35);
      --primary:#60a5fa;
      --primary-weak: rgba(96,165,250,.14);
      --success:#22c55e;
      --danger:#ef4444;
      --radius: 18px;
    }

    body.tg {
      --bg: var(--tg-theme-bg-color, #0b1220);
      --card: var(--tg-theme-secondary-bg-color, #0f172a);
      --text: var(--tg-theme-text-color, #e5e7eb);
      --muted: var(--tg-theme-hint-color, #9ca3af);
      --primary: var(--tg-theme-button-color, #60a5fa);
    }

    *{ box-sizing: border-box; }
    body{
      margin:0;
      font-family: Vazirmatn, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 700px at 70% -10%, rgba(96,165,250,.12), transparent 60%),
                  radial-gradient(1000px 700px at 10% 0%, rgba(34,197,94,.10), transparent 55%),
                  var(--bg);
      color: var(--text);
      overflow-x:hidden;
    }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 18px 16px 28px;
    }

    .topbar{
      position: sticky;
      top: 0;
      z-index: 10;
      padding: 14px 0 10px;
      background: linear-gradient(to bottom, rgba(11,18,32,.92), rgba(11,18,32,.65), rgba(11,18,32,0));
      backdrop-filter: blur(10px);
    }

    .brand{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }

    .brandRight{
      display:flex;
      align-items:flex-start;
      gap: 12px;
      min-width: 0;
    }

    .logo{
      width: 42px;
      height: 42px;
      border-radius: 14px;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      flex: 0 0 auto;
      box-shadow: 0 10px 20px rgba(0,0,0,.25);
    }
    .logo img{ width: 100%; height: 100%; object-fit: cover; }

    .title{
      font-size: 22px;
      font-weight: 900;
      letter-spacing: -0.3px;
      margin: 0;
      line-height: 1.2;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 72vw;
    }

    .subtitle{
      margin-top: 6px;
      font-size: 13px;
      color: var(--muted);
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-weight: 800;
      font-size: 13px;
      white-space: nowrap;
    }

    .btnGhost{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-family: inherit;
      font-weight: 900;
    }
    .btnGhost:active{ transform: translateY(1px); }

    .controls{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1fr 240px;
      gap: 10px;
    }
    @media (max-width: 700px){
      .controls{ grid-template-columns: 1fr; }
    }

    .search{
      width:100%;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      outline: none;
      box-shadow: 0 1px 0 rgba(0,0,0,.02);
    }
    .search::placeholder{ color: rgba(156,163,175,.9); }

    .seg{
      display:flex;
      background: rgba(255,255,255,.04);
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow:hidden;
    }
    .seg button{
      flex:1;
      padding: 10px 10px;
      border:0;
      background: transparent;
      cursor:pointer;
      color: var(--muted);
      font-weight: 900;
      font-family: inherit;
    }
    .seg button.active{
      color: var(--primary);
      background: var(--primary-weak);
    }

    .toolbar{
      margin-top: 10px;
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
      justify-content: space-between;
    }

    .select{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      font-family: inherit;
      font-weight: 900;
      outline:none;
      min-width: 220px;
    }

    .grid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 860px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: rgba(15,23,42,.75);
      border: 1px solid var(--border);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding: 14px;
    }

    .itemHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
    }

    .itemTitle{
      font-weight: 900;
      margin: 0 0 6px;
      font-size: 16px;
      line-height: 1.4;
    }

    .meta{
      font-size: 13px;
      color: var(--muted);
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
    }

    .tag{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.05);
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
    }

    .btnPrimary{
      border: 0;
      border-radius: 16px;
      padding: 10px 14px;
      cursor:pointer;
      background: var(--primary);
      color: #071023;
      font-weight: 900;
      font-family: inherit;
      white-space: nowrap;
      box-shadow: 0 12px 22px rgba(96,165,250,.18);
    }
    body.tg .btnPrimary{
      color: var(--tg-theme-button-text-color, #071023);
    }
    .btnPrimary:active{ transform: translateY(1px); }

    .likeBtn{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 16px;
      cursor:pointer;
      font-family: inherit;
      font-weight: 900;
      display:inline-flex;
      gap: 8px;
      align-items:center;
    }
    .likeBtn.liked{
      border-color: rgba(96,165,250,.45);
      background: rgba(96,165,250,.14);
      color: var(--primary);
    }

    .progressRow{
      margin-top: 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .bar{
      flex:1;
      height: 10px;
      border-radius: 999px;
      background: rgba(156,163,175,.16);
      overflow:hidden;
      border: 1px solid var(--border);
    }
    .bar > div{
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--primary), var(--success));
      border-radius: 999px;
      transition: width .25s ease;
    }
    .percent{
      font-weight: 900;
      color: var(--text);
      min-width: 44px;
      text-align:left;
    }

    /* Category gate */
    .catGrid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    @media (max-width: 700px){
      .catGrid{ grid-template-columns: 1fr; }
    }
    .catCard{
      padding: 16px;
      border-radius: 22px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      cursor: pointer;
      box-shadow: var(--shadow);
    }
    .catCard:active{ transform: translateY(1px); }
    .catName{
      font-size: 16px;
      font-weight: 900;
      margin: 0 0 6px;
    }
    .catDesc{
      margin: 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.6;
    }

    /* Continue watching + summary */
    .row2{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 860px){
      .row2{ grid-template-columns: 1fr; }
    }
    .bigStat{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
    }
    .bigStat h3{
      margin:0;
      font-size: 14px;
      font-weight: 900;
      color: var(--muted);
    }
    .bigStat .value{
      margin-top: 8px;
      font-size: 22px;
      font-weight: 900;
      letter-spacing: -0.3px;
    }

    .hint{
      margin-top: 10px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.7;
    }

    .empty{
      margin-top: 12px;
      padding: 18px;
      text-align:center;
      color: var(--muted);
    }

    /* Player modal (focus mode) */
    .overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 999;
    }
    .overlay.show{ display:flex; }
    .playerModal{
      width: min(980px, 96vw);
      max-height: 92vh;
      overflow:auto;
      background: rgba(15,23,42,.92);
      border: 1px solid var(--border);
      border-radius: 22px;
      box-shadow: 0 24px 60px rgba(0,0,0,.45);
      padding: 16px;
    }
    .playerHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
    }
    .playerTitle{
      margin:0;
      font-size: 16px;
      font-weight: 900;
      line-height: 1.5;
    }
    .closeBtn{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-family: inherit;
      font-weight: 900;
    }

    video,audio{
      width:100%;
      border-radius: 16px;
      outline:none;
      background: rgba(0,0,0,.25);
      margin-top: 12px;
    }

    .motivate{
      margin-top: 10px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.7;
    }
/* Small helpers */
    .muted{ color: var(--muted); }
    .hidden{ display:none !important; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="brandRight">
          <div class="logo" title="Ø³ÛŒÙ„Ø§Ù†Ù‡ Ø³Ø¨Ø²">
            <img id="logoImg" alt="Seylaneh Sabz Logo" />
          </div>
          <div style="min-width:0;">
            <h1 class="title">Ø¢Ú©Ø§Ø¯Ù…ÛŒ Ø³ÛŒÙ„Ø§Ù†Ù‡ Ø³Ø¨Ø²</h1>
            <div class="subtitle" id="tagline">ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ Ù…Ø³ØªÙ…Ø±ØŒ Ù…Ø²ÛŒØª Ø±Ù‚Ø§Ø¨ØªÛŒ Ù…Ø§</div>
          </div>
        </div>

        <button id="btnChangeCategory" class="btnGhost hidden">ØªØºÛŒÛŒØ± Ø¯Ø³ØªÙ‡</button>
      </div>

      <!-- Controls only shown after category selection -->
      <div id="controlsBlock" class="hidden">
        <div class="controls">
          <input id="q" class="search" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ø¢Ù…ÙˆØ²Ø´â€ŒÙ‡Ø§ (Ù…Ø«Ù„Ø§Ù‹: ÙØ±ÙˆØ´ØŒ Ù…Ø­ØµÙˆÙ„ØŒ ...)" />
          <div class="seg" role="tablist" aria-label="ÙÛŒÙ„ØªØ± Ù†ÙˆØ¹ Ù…Ø­ØªÙˆØ§">
            <button id="f_all" class="active" type="button">Ù‡Ù…Ù‡</button>
            <button id="f_audio" type="button">Ù¾Ø§Ø¯Ú©Ø³Øª</button>
            <button id="f_video" type="button">ÙˆÛŒØ¯ÛŒÙˆ</button>
          </div>
        </div>

        <div class="toolbar">
          <div class="pill" id="catPill">â€”</div>
          <select id="sortSel" class="select" aria-label="Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ">
            <option value="smart">Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯ (Ù¾ÛŒØ´â€ŒÙØ±Ø¶)</option>
            <option value="newest">Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† Ù…Ø­ØªÙˆØ§</option>
            <option value="liked">Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ù„Ø§ÛŒÚ©</option>
            <option value="engaging">Ø¬Ø°Ø§Ø¨â€ŒØªØ±ÛŒÙ† Ù…Ø­ØªÙˆØ§</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Category gate -->
    <div id="categoryGate">
      <div style="display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin-top:12px;">
        <div class="pill" style="border-radius:999px;">
          Ù¾ÛŒØ´Ø±ÙØª Ø´Ù…Ø§:
          <span id="overallProgress" style="font-weight:900; margin-right:6px;">0%</span>
        </div>

        <button id="btnContinue" class="btnGhost" style="border-radius:999px;" disabled>
          Ø§Ø¯Ø§Ù…Ù‡:
          <span id="continueTitle" style="font-weight:900; margin-right:6px;">â€”</span>
        </button>

        <div id="continueHint" class="hint" style="margin:0; flex-basis:100%; display:none;"></div>
      </div>

      <div class="catGrid" id="catGrid"></div>
    </div>

    <!-- Content list -->
    <div id="listArea" class="hidden">
      
      
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:12px;">
        <div class="pill">
          Ù¾ÛŒØ´Ø±ÙØª Ø§ÛŒÙ† Ø¯Ø³ØªÙ‡:
          <span id="catProgress" style="font-weight:900; margin-right:6px;">0%</span>
          <span class="muted">â€¢</span>
          <span id="catProgressHint" style="font-weight:900; margin-right:6px;">â€”</span>
        </div>

        <div class="pill" style="opacity:.9;">
          <span class="muted" id="microMotivation">Ù‡Ø± Ù‚Ø¯Ù… Ú©ÙˆÚ†Ú©ØŒ ÛŒÚ© Ø¹Ø§Ø¯Øª Ø¨Ø²Ø±Ú¯ Ù…ÛŒâ€ŒØ³Ø§Ø²Ø¯.</span>
        </div>
      </div>


      <div id="list" class="grid"></div>
    </div>

  </div>

  <!-- Player modal (focus mode) -->
  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="playerModal">
      <div class="playerHead">
        <div>
          <h3 id="nowTitle" class="playerTitle"></h3>
          <div class="meta" style="margin-top:8px;">
            <span class="tag" id="nowType">â€”</span>
            <span class="tag" id="nowDuration">â€”</span>
            <span class="tag" id="nowLikes">â™¡ 0</span>
          </div>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <button id="btnFullscreen" class="closeBtn hidden" style="border-radius:14px;">ØªÙ…Ø§Ù… ØµÙØ­Ù‡</button>
          <button id="btnClose" class="closeBtn">Ø¨Ø³ØªÙ†</button>
        </div>
      </div>

      <div id="playerArea"></div>

      <div class="progressRow" style="margin-top: 14px;">
        <div class="bar"><div id="nowBar"></div></div>
        <div class="percent" id="nowPercent">0%</div>
      </div>

      <div class="motivate" id="motivateLine">Ø§Ú¯Ø± ØªØ§ Ø¢Ø®Ø± Ø¨Ø±ÛŒØŒ ÙØ±Ø¯Ø§ Ø±Ø§Ø­Øªâ€ŒØªØ±ÛŒ.</div>
      <div class="hint">Ù¾ÛŒØ´Ø±ÙØª Ø´Ù…Ø§ Ø®ÙˆØ¯Ú©Ø§Ø± Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
    </div>
  </div>

</div>

<script>
/* =========================
   CONFIG (Supabase)
========================= */
const SUPABASE_URL = "https://szjwrqzgiekjaggqsuoh.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_hkKIc6r7pSDCJsUvoOafrg_vK8xQc0F";

/* =========================
   Logo (replace anytime)
   - replace LOGO_DATA_URI with your real logo data-uri or a public URL.
========================= */
const LOGO_DATA_URI =
  "data:image/svg+xml;utf8," +
  encodeURIComponent(`
  <svg xmlns="http://www.w3.org/2000/svg" width="96" height="96" viewBox="0 0 96 96">
    <defs>
      <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0" stop-color="#22c55e"/>
        <stop offset="1" stop-color="#60a5fa"/>
      </linearGradient>
    </defs>
    <rect width="96" height="96" rx="24" fill="rgba(255,255,255,.06)"/>
    <circle cx="48" cy="48" r="28" fill="url(#g)" opacity="0.95"/>
    <path d="M57 34c-9 2-15 8-17 17-1 6 2 12 8 13 6 1 12-3 14-9 2-5 1-14-5-21z"
          fill="rgba(7,16,35,.92)"/>
    <path d="M41 57c6-6 12-10 19-12" stroke="rgba(7,16,35,.85)" stroke-width="3" stroke-linecap="round"/>
  </svg>`);


/* =========================
   Telegram
========================= */
const tg = window.Telegram?.WebApp;

function resolveUserId() {
  // Preferred: real Telegram user id inside Telegram Mini App
  try {
    if (tg) {
      tg.ready();
      const id = tg.initDataUnsafe?.user?.id;
      if (id) return String(id);
    }
  } catch (e) {}

  // Fallbacks for web-preview/testing (so UI still renders)
  const qs = new URLSearchParams(location.search);
  const qid = qs.get("uid");
  if (qid) return String(qid);

  const saved = localStorage.getItem("dev_uid");
  if (saved) return saved;

  // Last resort: stable anonymous id for preview
  return "web_preview";
}

const TELEGRAM_ID = resolveUserId();

if (tg) {
  document.body.classList.add("tg");
  try { tg.expand(); } catch(e){}
}


/* =========================
   Helpers
========================= */
const $ = (id) => document.getElementById(id);

function secondsToMin(sec) {
  sec = Math.max(0, Math.floor(sec || 0));
  const m = Math.floor(sec / 60);
  const s = sec % 60;
  return `${m}:${String(s).padStart(2,'0')}`;
}
function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }
function calcPercent(pos, duration){
  if (!duration || duration <= 0) return 0;
  return clamp((pos / duration) * 100, 0, 100);
}
function show(el){ if(!el) return; el.hidden = false; el.classList.remove("hidden"); el.style.display = ""; el.style.visibility=""; el.style.height=""; el.style.maxHeight=""; el.style.overflow=""; el.style.pointerEvents=""; }
function hide(el){ if(!el) return; el.hidden = true; el.classList.add("hidden"); el.style.display = "none"; el.style.visibility="hidden"; el.style.height="0"; el.style.maxHeight="0"; el.style.overflow="hidden"; el.style.pointerEvents="none"; }

function captureCategoryGate(){
  categoryGateEl = $("categoryGate");
  categoryGateParent = categoryGateEl ? categoryGateEl.parentNode : null;
  categoryGateNextSibling = categoryGateEl ? categoryGateEl.nextSibling : null;
}

function detachCategoryGate(){
  if(!categoryGateEl) captureCategoryGate();
  if(!categoryGateEl || !categoryGateEl.parentNode) return;
  categoryGateEl.parentNode.removeChild(categoryGateEl);
}

function attachCategoryGate(){
  if(!categoryGateEl) captureCategoryGate();
  if(!categoryGateEl || !categoryGateParent) return;
  if(categoryGateEl.parentNode) return; // already attached
  if(categoryGateNextSibling && categoryGateNextSibling.parentNode === categoryGateParent){
    categoryGateParent.insertBefore(categoryGateEl, categoryGateNextSibling);
  }else{
    categoryGateParent.appendChild(categoryGateEl);
  }
}

/* =========================
   Supabase REST
========================= */
async function sGet(path) {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${path}`, {
    headers: {
      "apikey": SUPABASE_ANON_KEY,
      "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
    }
  });
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}

async function sPost(path, body, merge=false) {
  const headers = {
    "apikey": SUPABASE_ANON_KEY,
    "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
    "Content-Type": "application/json",
  };
  if (merge) headers["Prefer"] = "resolution=merge-duplicates";
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${path}`, {
    method: "POST",
    headers,
    body: JSON.stringify(body),
  });
  if (!res.ok) throw new Error(await res.text());
  return true;
}

async function sDelete(path) {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${path}`, {
    method: "DELETE",
    headers: {
      "apikey": SUPABASE_ANON_KEY,
      "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
    }
  });
  if (!res.ok) throw new Error(await res.text());
  return true;
}

/* =========================
   Categories (fixed)
========================= */
const CATEGORIES = [
  { key: "sales",  title: "Ø¢Ù…ÙˆØ²Ø´ ÙØ±ÙˆØ´",   desc: "Ù…Ù‡Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø°Ø§Ú©Ø±Ù‡ØŒ Ù¾ÛŒÚ¯ÛŒØ±ÛŒØŒ Ø¨Ø³ØªÙ† ÙØ±ÙˆØ´" },
  { key: "product",title: "Ø¢Ù…ÙˆØ²Ø´ Ù…Ø­ØµÙˆÙ„", desc: "Ø¯Ø§Ù†Ø´ Ù…Ø­ØµÙˆÙ„ØŒ Ù…Ø²Ø§ÛŒØ§ØŒ ØªÙØ§ÙˆØªâ€ŒÙ‡Ø§ Ùˆ Ú©Ø§Ø±Ø¨Ø±Ø¯Ù‡Ø§" },
  { key: "mindset",title: "Ù†Ú¯Ø±Ø´ÛŒ",       desc: "ØªÙÚ©Ø±ØŒ Ø§Ù†Ú¯ÛŒØ²Ù‡ØŒ Ù…Ø¯ÛŒØ±ÛŒØª Ø²Ù…Ø§Ù†ØŒ Ø±Ø´Ø¯ ÙØ±Ø¯ÛŒ" },
  { key: "campaign",title:"Ø¢Ù…ÙˆØ²Ø´ Ú©Ù…Ù¾ÛŒÙ†", desc: "Ú©Ù…Ù¾ÛŒÙ†â€ŒØ³Ø§Ø²ÛŒØŒ Ø§Ø¬Ø±Ø§ØŒ KPI Ùˆ ØªØ­Ù„ÛŒÙ„" },
  { key: "book",  title: "Ø®Ù„Ø§ØµÙ‡ Ú©ØªØ§Ø¨",  desc: "Ú†Ú©ÛŒØ¯Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ ØªØµÙ…ÛŒÙ…â€ŒÚ¯ÛŒØ±ÛŒ Ø¨Ù‡ØªØ±" },
];

function renderCategories(){
  const grid = $("catGrid");
  grid.innerHTML = "";
  CATEGORIES.forEach(c => {
    const div = document.createElement("div");
    div.className = "catCard";
    div.innerHTML = `<div class="catName">${c.title}</div><p class="catDesc">${c.desc}</p>`;
    div.onclick = () => selectCategory(c.key);
    grid.appendChild(div);
  });
}

/* =========================
   State
========================= */
let ALL_CONTENTS = [];
let CURRENT_CATEGORY = null;
let TYPE_FILTER = "all";     // all | audio | video
let SORT_MODE = "smart";     // smart | newest | liked | engaging

let categoryGateEl = null;
let categoryGateParent = null;
let categoryGateNextSibling = null;

let userProfile = null;

let progressByContent = new Map();     // content_id -> {last_position_seconds, completion_percent, updated_at, duration_seconds}
let engagementByContent = new Map();   // content_id -> total active_seconds (all users)
let likeCountByContent = new Map();    // content_id -> count
let likedByMe = new Set();             // content_id

let continueItem = null;

/* =========================
   UI init
========================= */
$("logoImg").src = LOGO_DATA_URI;

/* =========================
   Telegram Profile (no onboarding)
========================= */
function getTelegramProfile(){
  const u = tg?.initDataUnsafe?.user;
  if(!u) return { full_name: null, username: null };
  const full_name = [u.first_name, u.last_name].filter(Boolean).join(" ").trim() || null;
  const username = u.username ? String(u.username) : null;
  return { full_name, username };
}

/* =========================
   Progress / Likes / Engagement loaders
========================= */

async function loadMyProgress(){
  const rows = await sGet(`progress?select=content_id,last_position_seconds,completion_percent,updated_at,duration_seconds&telegram_id=eq.${encodeURIComponent(TELEGRAM_ID)}&limit=5000`);
  progressByContent = new Map();
  rows.forEach(r => progressByContent.set(r.content_id, r));
}

async function loadEngagementAllUsers(contentIds){
  // Ø¬Ø°Ø§Ø¨â€ŒØªØ±ÛŒÙ† Ù…Ø­ØªÙˆØ§: Ù…Ø¬Ù…ÙˆØ¹ active_seconds Ù‡Ù…Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø±ÙˆÛŒ Ù‡Ø± Ù…Ø­ØªÙˆØ§
  // Ø¨Ø±Ø§ÛŒ MVP: ØªÙ…Ø§Ù… progress Ù‡Ø§ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ù…Ø­ØªÙˆØ§Ù‡Ø§ Ø±Ø§ Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒÙ… Ùˆ JS Ø¬Ù…Ø¹ Ù…ÛŒâ€ŒØ²Ù†Ø¯.
  // Ø§Ú¯Ø± Ø¯ÛŒØªØ§Øª Ø²ÛŒØ§Ø¯ Ø´Ø¯ØŒ Ø¨Ø¹Ø¯Ø§Ù‹ Ø¨Ø§ ÛŒÚ© View/RPC Ø¨Ù‡ÛŒÙ†Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ….
  if (!contentIds.length) { engagementByContent = new Map(); return; }

  const inList = contentIds.join(",");
  const rows = await sGet(`progress?select=content_id,active_seconds&content_id=in.(${inList})&limit=10000`);
  engagementByContent = new Map();
  rows.forEach(r => {
    const prev = engagementByContent.get(r.content_id) || 0;
    engagementByContent.set(r.content_id, prev + (r.active_seconds || 0));
  });
}

async function loadLikesForContents(contentIds){
  if (!contentIds.length) {
    likeCountByContent = new Map();
    likedByMe = new Set();
    return;
  }
  const inList = contentIds.join(",");
  // Ù‡Ù…Ù‡ Ù„Ø§ÛŒÚ©â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§Ø±Ø´
  const rowsAll = await sGet(`likes?select=content_id&content_id=in.(${inList})&limit=10000`);
  likeCountByContent = new Map();
  rowsAll.forEach(r => {
    likeCountByContent.set(r.content_id, (likeCountByContent.get(r.content_id) || 0) + 1);
  });
  // Ù„Ø§ÛŒÚ©â€ŒÙ‡Ø§ÛŒ Ø®ÙˆØ¯Ù… Ø¨Ø±Ø§ÛŒ Ø­Ø§Ù„Øª liked
  const rowsMe = await sGet(`likes?select=content_id&content_id=in.(${inList})&telegram_id=eq.${encodeURIComponent(TELEGRAM_ID)}&limit=5000`);
  likedByMe = new Set(rowsMe.map(r => r.content_id));
}

async function toggleLike(contentId){
  const isLiked = likedByMe.has(contentId);
  try{
    if (isLiked){
      await sDelete(`likes?telegram_id=eq.${encodeURIComponent(TELEGRAM_ID)}&content_id=eq.${contentId}`);
      likedByMe.delete(contentId);
      likeCountByContent.set(contentId, Math.max(0, (likeCountByContent.get(contentId)||1) - 1));
    } else {
      await sPost("likes", [{ telegram_id: TELEGRAM_ID, content_id: contentId, created_at: new Date().toISOString() }], false);
      likedByMe.add(contentId);
      likeCountByContent.set(contentId, (likeCountByContent.get(contentId)||0) + 1);
    }
  }catch(e){
    console.error(e);
  }
}

/* =========================
   Continue watching
========================= */
async function loadContinueWatching(){
  const rows = await sGet(`progress?select=content_id,updated_at,last_position_seconds,completion_percent&telegram_id=eq.${encodeURIComponent(TELEGRAM_ID)}&order=updated_at.desc&limit=1`);
  const p = rows[0];
  if (!p) return null;
  const c = ALL_CONTENTS.find(x => x.id === p.content_id);
  if (!c) return null;
  return { content: c, progress: p };
}

function updateContinueUI(){
  if (!continueItem){
    $("continueTitle").textContent = "â€”";
    $("continueHint").textContent = "Ø¢Ø®Ø±ÛŒÙ† Ø¢Ù…ÙˆØ²Ø´ÛŒ Ú©Ù‡ Ù†ÛŒÙ…Ù‡â€ŒÚ©Ø§Ø±Ù‡ Ù…Ø§Ù†Ø¯Ù‡ Ø§ÛŒÙ†Ø¬Ø§ Ù…ÛŒâ€ŒØ¢ÛŒØ¯.";
    $("btnContinue").disabled = true;
    return;
  }
  const {content, progress} = continueItem;
  $("continueTitle").textContent = content.title.length > 18 ? content.title.slice(0,18) + "â€¦" : content.title;
  $("continueHint").textContent = `Ù¾ÛŒØ´Ø±ÙØª: ${Number(progress.completion_percent||0).toFixed(0)}%`;
  $("btnContinue").disabled = false;
  $("btnContinue").onclick = () => openPlayer(content);
}

/* =========================
   Category selection
========================= */
function selectCategory(key){
  CURRENT_CATEGORY = key;
  detachCategoryGate();
  show($("listArea"));
  show($("controlsBlock"));
  show($("btnChangeCategory"));

  const catObj = CATEGORIES.find(x => x.key === key);
  $("catPill").textContent = catObj ? `Ø¯Ø³ØªÙ‡: ${catObj.title}` : "â€”";

  // micro copy
  const lines = [
    "ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ Ù…Ø³ØªÙ…Ø±ØŒ Ù…Ø²ÛŒØª Ø±Ù‚Ø§Ø¨ØªÛŒ Ù…Ø§Ø³Øª.",
    "Ù‡Ø± Ù‚Ø¯Ù… Ú©ÙˆÚ†Ú©ØŒ ÛŒÚ© Ø¹Ø§Ø¯Øª Ø¨Ø²Ø±Ú¯ Ù…ÛŒâ€ŒØ³Ø§Ø²Ø¯.",
    "Ø«Ø¨Ø§Øª Ø¯Ø± Ø¢Ù…ÙˆØ²Ø´ØŒ Ø«Ø¨Ø§Øª Ø¯Ø± Ù†ØªÛŒØ¬Ù‡ Ù…ÛŒâ€ŒØ¢ÙˆØ±Ø¯.",
  ];
  $("microMotivation").textContent = lines[Math.floor(Math.random()*lines.length)];

  applyFiltersAndRender();
}

$("btnChangeCategory").onclick = () => {
  CURRENT_CATEGORY = null;
  hide($("listArea"));
  hide($("controlsBlock"));
  hide($("btnChangeCategory"));

  // bring category gate back (hard attach) and re-render categories (safe)
  attachCategoryGate();
  show($("categoryGate"));
  renderCategories();

  // reset filters/search for a clean start
  $("q").value = "";
  setType("all");
  $("sortSel").value = "smart";
  SORT_MODE = "smart";
};

/* =========================
   Filters
========================= */
$("f_all").onclick = () => setType("all");
$("f_audio").onclick = () => setType("audio");
$("f_video").onclick = () => setType("video");
$("q").addEventListener("input", () => applyFiltersAndRender());
$("sortSel").addEventListener("change", () => { SORT_MODE = $("sortSel").value; applyFiltersAndRender(); });

function setType(t){
  TYPE_FILTER = t;
  $("f_all").classList.toggle("active", t==="all");
  $("f_audio").classList.toggle("active", t==="audio");
  $("f_video").classList.toggle("active", t==="video");
  applyFiltersAndRender();
}

/* =========================
   Rendering list
========================= */
function contentTypeLabel(t){ return t === "audio" ? "Ù¾Ø§Ø¯Ú©Ø³Øª" : "ÙˆÛŒØ¯ÛŒÙˆ"; }

function getContentCategoryKey(c){
  // Ù…Ø­ØªÙˆØ§ Ø¨Ø§ÛŒØ¯ Ø³ØªÙˆÙ† category_key Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯. Ø§Ú¯Ø± Ù†Ø¯Ø§Ø±Ù‡ØŒ "other"
  // Ù…Ø§ ÙÙ‚Ø· 5 Ø¯Ø³ØªÙ‡ Ø¯Ø§Ø±ÛŒÙ…Ø› Ù‡Ø±Ú†ÛŒ ØºÛŒØ± Ø§Ø² Ø§ÛŒÙ†â€ŒÙ‡Ø§ "other" Ù…ÛŒâ€ŒØ´ÙˆØ¯.
  const k = (c.category_key || "").trim();
  if (CATEGORIES.some(x => x.key === k)) return k;
  return "other";
}

function applyFiltersAndRender(){
  if (!CURRENT_CATEGORY) return;

  const q = ($("q").value || "").trim().toLowerCase();

  // 1) category filter
  let items = ALL_CONTENTS.filter(c => {
    const k = getContentCategoryKey(c);
    return k === CURRENT_CATEGORY;
  });

  // Ø§Ú¯Ø± Ø¯Ø³ØªÙ‡ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯ ÙˆÙ„ÛŒ Ú†ÛŒØ²ÛŒ Ù†Ø¨ÙˆØ¯ØŒ ÛŒÚ© Ù¾ÛŒØ§Ù…
  if (!items.length){
    $("list").innerHTML = `<div class="card empty">Ø¯Ø± Ø§ÛŒÙ† Ø¯Ø³ØªÙ‡ Ù‡Ù†ÙˆØ² Ù…Ø­ØªÙˆØ§ÛŒÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡.</div>`;
    updateCategoryProgress(items);
    return;
  }

  // 2) type filter
  if (TYPE_FILTER !== "all"){
    items = items.filter(x => x.type === TYPE_FILTER);
  }

  // 3) search
  if (q){
    items = items.filter(x => (x.title || "").toLowerCase().includes(q));
  }

  // 4) compute per-item derived: progress, likes, remaining, engagement
  // 5) sort
  items.sort((a,b) => compareItems(a,b));

  renderItems(items);
  updateCategoryProgress(items);
}

function compareItems(a,b){
  const pa = progressByContent.get(a.id);
  const pb = progressByContent.get(b.id);

  const pctA = Number(pa?.completion_percent || 0);
  const pctB = Number(pb?.completion_percent || 0);

  const incompleteA = pctA < 99.9;
  const incompleteB = pctB < 99.9;

  const likesA = likeCountByContent.get(a.id) || 0;
  const likesB = likeCountByContent.get(b.id) || 0;

  const engA = engagementByContent.get(a.id) || 0;
  const engB = engagementByContent.get(b.id) || 0;

  const createdA = a.created_at ? new Date(a.created_at).getTime() : a.id;
  const createdB = b.created_at ? new Date(b.created_at).getTime() : b.id;

  // sort modes
  if (SORT_MODE === "newest"){
    return createdB - createdA;
  }
  if (SORT_MODE === "liked"){
    return (likesB - likesA) || (createdB - createdA);
  }
  if (SORT_MODE === "engaging"){
    return (engB - engA) || (createdB - createdA);
  }

  // smart default:
  // 1) incomplete on top
  if (incompleteA !== incompleteB) return incompleteA ? -1 : 1;
  // 2) within incomplete: higher remaining? (actually we want closer to finish? let's do lower pct first? no, show closer to finish to complete)
  if (incompleteA && incompleteB) {
    // show higher pct first to encourage completion
    if (pctA !== pctB) return pctB - pctA;
  }
  // 3) newest next
  return createdB - createdA;
}

function renderItems(items){
  const list = $("list");
  list.innerHTML = "";

  items.forEach(item => {
    const p = progressByContent.get(item.id);
    const pct = Number(p?.completion_percent || 0);
    const lastPos = Number(p?.last_position_seconds || 0);
    const duration = Number(item.duration_seconds || 0);

    const likeCount = likeCountByContent.get(item.id) || 0;
    const isLiked = likedByMe.has(item.id);

    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <div class="itemHead">
        <div style="flex:1; min-width:0;">
          <div class="itemTitle">${item.title}</div>
          <div class="meta">
            <span class="tag">${contentTypeLabel(item.type)}</span>
            <span class="tag">Ù…Ø¯Øª ${secondsToMin(duration)}</span>
            <span class="tag">â™¡ ${likeCount}</span>
          </div>
        </div>

        <div style="display:flex; gap:10px; align-items:center;">
          <button class="likeBtn ${isLiked ? "liked" : ""}" data-like="${item.id}" title="Ù„Ø§ÛŒÚ©">
            ${isLiked ? "â™¥" : "â™¡"} <span>${likeCount}</span>
          </button>
          <button class="btnPrimary" data-play="${item.id}">Ù¾Ø®Ø´</button>
        </div>
      </div>

      <div class="progressRow">
        <div class="bar"><div style="width:${pct}%;"></div></div>
        <div class="percent">${pct.toFixed(0)}%</div>
      </div>
    `;

    // handlers
    card.querySelector(`[data-play="${item.id}"]`).onclick = () => openPlayer(item);
    card.querySelector(`[data-like="${item.id}"]`).onclick = async () => {
      await toggleLike(item.id);
      // update this card like UI immediately
      applyFiltersAndRender();
      // if player open on same content, update likes label
      if (currentPlayerContent && currentPlayerContent.id === item.id){
        $("nowLikes").textContent = `â™¡ ${likeCountByContent.get(item.id) || 0}`;
      }
    };

    list.appendChild(card);
  });
}

/* =========================
   Progress summaries
========================= */
function updateCategoryProgress(itemsInView){
  // Ù¾ÛŒØ´Ø±ÙØª Ø¯Ø± Ø¯Ø³ØªÙ‡: Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† completion Ø±ÙˆÛŒ Ú©Ù„ Ù…Ø­ØªÙˆØ§Ù‡Ø§ÛŒ Ø¯Ø³ØªÙ‡ (Ø­ØªÛŒ Ø§Ú¯Ø± ÙÛŒÙ„ØªØ± Ù†ÙˆØ¹ ÙØ¹Ø§Ù„ Ø¨Ø§Ø´Ø¯)
  // Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ù…Ù†ØµÙ Ø¨Ø§Ø´Ø¯ØŒ Ø±ÙˆÛŒ Ú©Ù„ Ù…Ø­ØªÙˆØ§Ù‡Ø§ÛŒ Ø¯Ø³ØªÙ‡ Ø­Ø³Ø§Ø¨ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ù†Ù‡ ÙÙ‚Ø· view.
  const allInCat = ALL_CONTENTS.filter(c => getContentCategoryKey(c) === CURRENT_CATEGORY);
  if (!allInCat.length){
    $("catProgress").textContent = "0%";
    $("catProgressHint").textContent = "â€”";
    return;
  }
  let sum = 0;
  allInCat.forEach(c => {
    sum += Number(progressByContent.get(c.id)?.completion_percent || 0);
  });
  const avg = sum / allInCat.length;
  $("catProgress").textContent = `${avg.toFixed(0)}%`;
  $("catProgressHint").textContent = `${allInCat.length} Ø¢Ù…ÙˆØ²Ø´ Ø¯Ø± Ø§ÛŒÙ† Ø¯Ø³ØªÙ‡`;
}

function updateOverallProgress(){
  if (!ALL_CONTENTS.length){
    $("overallProgress").textContent = "0%";
    return;
  }
  let sum = 0;
  ALL_CONTENTS.forEach(c => sum += Number(progressByContent.get(c.id)?.completion_percent || 0));
  const avg = sum / ALL_CONTENTS.length;
  $("overallProgress").textContent = `${avg.toFixed(0)}%`;
}

/* =========================
   Player (no download, no last point label)
========================= */
let currentPlayerContent = null;
let progressTimer = null;

$("btnClose").onclick = closePlayer;
$("btnFullscreen").onclick = () => {
  const v = $("playerArea").querySelector("video");
  if (!v) return;
  // Standard fullscreen
  if (v.requestFullscreen) return v.requestFullscreen();
  // Safari iOS fallback
  if (v.webkitEnterFullscreen) return v.webkitEnterFullscreen();
  // Older WebKit
  if (v.webkitRequestFullscreen) return v.webkitRequestFullscreen();
};
$("overlay").addEventListener("click", (e) => {
  if (e.target === $("overlay")) closePlayer();
});

function setMotivationLine(pct){
  const p = Math.floor(pct);
  if (p >= 95) return "ÙÙ‚Ø· Ú†Ù†Ø¯ Ø«Ø§Ù†ÛŒÙ‡ ØªØ§ Ù¾Ø§ÛŒØ§Ù†! Ø¹Ø§Ù„ÛŒÙ‡ ğŸ‘Œ";
  if (p >= 70) return "ØªÙ‚Ø±ÛŒØ¨Ø§Ù‹ ØªÙ…ÙˆÙ…Ø´ Ú©Ø±Ø¯ÛŒ. Ù‡Ù…ÛŒÙ† ÛŒÚ©â€ŒØ°Ø±Ù‡ Ø±Ùˆ Ø¨Ø¨Ù†Ø¯.";
  if (p >= 30) return "Ø®ÙˆØ¨Ù‡. Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø¯Ù‡ ØªØ§ Ù†Ú©ØªÙ‡â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ Ø¬Ù…Ø¹ Ø¨Ø´Ù‡.";
  return "Ø´Ø±ÙˆØ¹ Ø¹Ø§Ù„ÛŒÙ‡. ÙÙ‚Ø· Û² Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¯ÛŒÚ¯Ù‡ Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø¯Ù‡.";
}

async function openPlayer(content){
  currentPlayerContent = content;

  // UI header
  $("nowTitle").textContent = content.title;
  $("nowType").textContent = contentTypeLabel(content.type);
  $("nowDuration").textContent = `Ù…Ø¯Øª ${secondsToMin(content.duration_seconds || 0)}`;

  const likes = likeCountByContent.get(content.id) || 0;
  $("nowLikes").textContent = `â™¡ ${likes}`;

  // build media
  const area = $("playerArea");
  area.innerHTML = "";

  const isVideo = content.type === "video";
  // Fullscreen button only for videos
  if (isVideo) show($("btnFullscreen")); else hide($("btnFullscreen"));
  const media = document.createElement(isVideo ? "video" : "audio");
  media.controls = true;
  media.src = content.file_path;

  // disable download as much as possible
  media.setAttribute("controlsList", "nodownload noplaybackrate");
  media.setAttribute("disablePictureInPicture", "true");
  media.oncontextmenu = () => false;
  if (isVideo) {
    // Allow fullscreen on mobile (especially iOS): do NOT force inline playback
    media.playsInline = false;
  }

  area.appendChild(media);

  // show modal
  $("overlay").classList.add("show");
  $("overlay").setAttribute("aria-hidden", "false");

  // resume silently
  const p = progressByContent.get(content.id);
  const lastPos = Number(p?.last_position_seconds || 0);
  const duration = Number(content.duration_seconds || 0);

  function updateUI(currentTime){
    const pos = Math.floor(currentTime || 0);
    const pct = calcPercent(pos, duration);
    $("nowPercent").textContent = `${pct.toFixed(0)}%`;
    $("nowBar").style.width = `${pct}%`;
    $("motivateLine").textContent = setMotivationLine(pct);
  }

  media.addEventListener("loadedmetadata", () => {
    if (lastPos > 0 && lastPos < (media.duration || 999999)) {
      media.currentTime = lastPos;
    }
    updateUI(media.currentTime);
  });

  // track progress every 10 seconds + on pause/end
  let lastSentAt = 0;

  async function saveNow(force=false){
    const pos = Math.floor(media.currentTime || 0);
    const pct = calcPercent(pos, duration);
    updateUI(media.currentTime);

    // Ø°Ø®ÛŒØ±Ù‡
    try{
      await sPost("progress", [{
        telegram_id: TELEGRAM_ID,
        content_id: content.id,
        last_position_seconds: pos,
        max_position_seconds: pos,
        duration_seconds: duration || 0,
        completion_percent: Number(pct.toFixed(2)),
        active_seconds: pos, // MVP Ø³Ø§Ø¯Ù‡ (Ø§Ú¯Ø± Ø®ÙˆØ§Ø³ØªÛŒ Ø¯Ù‚ÛŒÙ‚â€ŒØªØ± Ú©Ù†ÛŒÙ…ØŒ Ø¨Ø¹Ø¯Ø§Ù‹)
        updated_at: new Date().toISOString()
      }], true);

      // cache update
      progressByContent.set(content.id, {
        content_id: content.id,
        last_position_seconds: pos,
        completion_percent: Number(pct.toFixed(2)),
        updated_at: new Date().toISOString(),
        duration_seconds: duration || 0
      });
      updateOverallProgress();
    }catch(e){
      console.error(e);
    }
  }

  media.addEventListener("timeupdate", () => {
    updateUI(media.currentTime);
    if (Math.abs(media.currentTime - lastSentAt) >= 10) {
      lastSentAt = media.currentTime;
      saveNow(false);
    }
  });

  media.addEventListener("pause", () => saveNow(true));
  media.addEventListener("ended", () => {
    media.currentTime = duration || media.duration || 0;
    saveNow(true);
  });

  // initial UI
  updateUI(lastPos);

  // subtle: stop any previous timer
  if (progressTimer) clearInterval(progressTimer);
}

function closePlayer(){
  try{ hide($("btnFullscreen")); }catch(e){}
  $("overlay").classList.remove("show");
  $("overlay").setAttribute("aria-hidden", "true");
  currentPlayerContent = null;
  if (progressTimer) clearInterval(progressTimer);
  progressTimer = null;
  // refresh list UI (percent updates)
  if (CURRENT_CATEGORY) applyFiltersAndRender();
}

/* =========================
   Refresh All
========================= */
async function refreshAll(){
  // 1) Telegram profile (no onboarding)
  userProfile = getTelegramProfile();

  // Optional: store what we can in users table (no blocking UI)
  // NOTE: mobile/job_title are not available from Telegram Mini App.
  try{
    await sPost("users", [{
      telegram_id: TELEGRAM_ID,
      full_name: userProfile?.full_name,
      job_title: null,
      mobile: null,
      department: null,
      updated_at: new Date().toISOString()
    }], true);
  }catch(e){ /* ignore */ }


  // 2) load contents
  // IMPORTANT: contents table needs columns: category_key, created_at
  // If created_at is missing, we fallback to id sorting.
  ALL_CONTENTS = await sGet("contents?select=id,title,type,duration_seconds,file_path,category_key,created_at&order=id.desc&limit=5000");

  // 3) load my progress
  await loadMyProgress();

  // 4) continue watching
  continueItem = await loadContinueWatching();
  updateContinueUI();

  // 5) overall progress
  updateOverallProgress();

  // 6) categories UI
  renderCategories();

  // 7) precompute likes + engagement for current category when chosen
  // (we compute on demand inside selectCategory)
}

/* =========================
   Start
========================= */
(async () => {
  try{
    await refreshAll();

    // attach after category selection:
    // whenever category changes, reload likes+engagement for that category contents
    const _selectCategory = selectCategory;
    selectCategory = async (key) => {
      CURRENT_CATEGORY = key;

      // for this category, get ids
      const ids = ALL_CONTENTS
        .filter(c => getContentCategoryKey(c) === key)
        .map(c => c.id);

      // load likes + engagement for these ids (for sorting)
      try{
        await loadLikesForContents(ids);
      }catch(e){ console.error(e); likeCountByContent = new Map(); likedByMe = new Set(); }

      try{
        await loadEngagementAllUsers(ids);
      }catch(e){ console.error(e); engagementByContent = new Map(); }

      // now call original select
      _selectCategory(key);
    };

  }catch(e){
    console.error(e);
    // minimal fail UI
    $("catGrid").innerHTML = `<div class="card empty">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ. ØªÙ†Ø¸ÛŒÙ…Ø§Øª Supabase ÛŒØ§ Ø¬Ø¯ÙˆÙ„â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.</div>`;
  }
})();
</script>
</body>
</html>
